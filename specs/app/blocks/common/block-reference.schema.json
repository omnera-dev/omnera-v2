{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "block-reference.schema.json",
  "title": "Block Reference",
  "description": "Reference to a reusable block template with variable substitution",
  "type": "object",
  "properties": {
    "block": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Name of the block template to reference (must match a block name in the blocks array)"
    },
    "vars": {
      "type": "object",
      "description": "Variables to substitute in the block template",
      "patternProperties": {
        "^[a-zA-Z][a-zA-Z0-9]*$": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "number"
            },
            {
              "type": "boolean"
            }
          ]
        }
      },
      "additionalProperties": false
    }
  },
  "required": ["block", "vars"],
  "additionalProperties": false,
  "examples": [
    {
      "block": "icon-badge",
      "vars": {
        "color": "orange",
        "icon": "users",
        "text": "6 à 15 personnes"
      }
    },
    {
      "block": "cta-button",
      "vars": {
        "label": "Get Started",
        "variant": "primary"
      }
    },
    {
      "block": "section-header",
      "vars": {
        "titleColor": "pourpre",
        "title": "notre mission",
        "subtitle": "Rendre la culture du consentement accessible à tous"
      }
    }
  ],
  "x-specs": [
    {
      "id": "APP-BLOCKS-REFERENCE-001",
      "given": "block reference with required properties",
      "when": "block and vars are provided",
      "then": "it should validate minimal block reference structure at build time",
      "validation": {
        "setup": {
          "validReference": {
            "block": "my-block",
            "vars": {
              "color": "blue"
            }
          },
          "invalidReferences": [
            {
              "block": "my-block"
            },
            {
              "vars": {
                "color": "blue"
              }
            },
            {}
          ]
        },
        "assertions": [
          "Valid: Both block and vars present",
          "Invalid: Missing vars (vars is required even if empty)",
          "Invalid: Missing block (cannot instantiate without template name)",
          "Invalid: Empty object (both properties required)"
        ]
      },
      "application": {
        "blocks": [
          {
            "name": "my-block",
            "type": "div",
            "props": {
              "className": "block-$color"
            },
            "content": "Block content"
          }
        ],
        "pages": [
          {
            "name": "Demo",
            "path": "/demo",
            "sections": [
              {
                "block": "my-block",
                "vars": {
                  "color": "blue"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-my-block\" class=\"block-blue\">Block content</div>",
        "assertions": [
          "Required properties: BOTH 'block' and 'vars' must be present",
          "block='my-block': Template name to instantiate",
          "vars={'color': 'blue'}: Data for variable substitution",
          "vars is REQUIRED even if empty (vars: {})",
          "Missing either property fails validation at build time"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-002",
      "given": "block reference block property",
      "when": "block is block name in kebab-case",
      "then": "it should look up and instantiate matching block template",
      "application": {
        "blocks": [
          {
            "name": "icon-badge",
            "type": "badge",
            "content": "$text"
          },
          {
            "name": "cta-button",
            "type": "button",
            "content": "$label"
          }
        ],
        "pages": [
          {
            "name": "Home",
            "path": "/",
            "sections": [
              {
                "block": "icon-badge",
                "vars": {
                  "text": "New"
                }
              },
              {
                "block": "cta-button",
                "vars": {
                  "label": "Click"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-icon-badge\">New</div><button data-testid=\"block-cta-button\">Click</button>",
        "assertions": [
          "block property: Template name lookup mechanism",
          "Reference 1: block='icon-badge' → finds block with name='icon-badge'",
          "Reference 2: block='cta-button' → finds block with name='cta-button'",
          "Each reference instantiates its corresponding template",
          "block property value MUST match existing block name exactly"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-003",
      "given": "block reference block pattern",
      "when": "block matches ^[a-z][a-z0-9-]*$ pattern",
      "then": "it should validate kebab-case naming at build time",
      "validation": {
        "setup": {
          "validRefs": ["icon-badge", "cta", "section-header-2", "my-component"],
          "invalidRefs": ["IconBadge", "cta_button", "section header", "2-columns", ""]
        },
        "assertions": [
          "Valid: 'icon-badge', 'cta', 'section-header-2', 'my-component'",
          "Invalid: 'IconBadge' (uppercase), 'cta_button' (underscore)",
          "Invalid: 'section header' (space), '2-columns' (starts with digit), '' (empty)",
          "Pattern ensures block matches block naming convention"
        ]
      },
      "application": {
        "blocks": [
          {
            "name": "icon-badge",
            "type": "badge"
          },
          {
            "name": "cta",
            "type": "button"
          },
          {
            "name": "section-header-2",
            "type": "section"
          },
          {
            "name": "my-component",
            "type": "div"
          }
        ],
        "pages": [
          {
            "name": "Demo",
            "path": "/demo",
            "sections": [
              {
                "block": "icon-badge",
                "vars": {}
              },
              {
                "block": "cta",
                "vars": {}
              },
              {
                "block": "section-header-2",
                "vars": {}
              },
              {
                "block": "my-component",
                "vars": {}
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-icon-badge\"></div><button data-testid=\"block-cta\"></button><section data-testid=\"block-section-header-2\"></section><div data-testid=\"block-my-component\"></div>",
        "assertions": [
          "Naming pattern: ^[a-z][a-z0-9-]*$ (kebab-case)",
          "Valid: 'icon-badge', 'cta', 'section-header-2', 'my-component'",
          "Must start with lowercase letter: [a-z]",
          "Can contain: lowercase letters, digits, hyphens",
          "Invalid: 'IconBadge' (uppercase), 'cta_button' (underscore), 'section header' (space)",
          "Invalid: '2-columns' (starts with digit), '' (empty string)",
          "Build-time validation enforces consistent naming"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-004",
      "given": "block reference block validation",
      "when": "block value must match existing block name in blocks array",
      "then": "it should fail validation if referenced block doesn't exist",
      "validation": {
        "setup": {
          "blocks": [
            {
              "name": "icon-badge",
              "type": "badge"
            },
            {
              "name": "cta-button",
              "type": "button"
            }
          ],
          "validReference": {
            "block": "icon-badge",
            "vars": {}
          },
          "invalidReference": {
            "block": "non-existent-block",
            "vars": {}
          }
        },
        "assertions": [
          "Valid: block='icon-badge' exists in blocks array",
          "Invalid: block='non-existent-block' not found in blocks array",
          "Build-time validation ensures all references resolve",
          "Prevents runtime errors from missing block templates"
        ]
      },
      "application": {
        "blocks": [
          {
            "name": "icon-badge",
            "type": "badge",
            "content": "Badge"
          },
          {
            "name": "cta-button",
            "type": "button",
            "content": "Button"
          }
        ],
        "pages": [
          {
            "name": "Valid",
            "path": "/valid",
            "sections": [
              {
                "block": "icon-badge",
                "vars": {}
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-icon-badge\">Badge</div>",
        "assertions": [
          "Reference validation: block value MUST exist in blocks array",
          "Valid: block='icon-badge' → Found in blocks[] ✓",
          "Invalid: block='non-existent-block' → NOT found in blocks[] ✗",
          "Build-time validation prevents broken references",
          "Catches typos and missing block definitions early",
          "Prevents runtime errors from unresolved templates"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-005",
      "given": "block reference vars object",
      "when": "vars contains variable name-value pairs",
      "then": "it should provide all data needed for template substitution",
      "application": {
        "blocks": [
          {
            "name": "user-card",
            "type": "card",
            "children": [
              {
                "type": "text",
                "props": {
                  "level": "h3"
                },
                "content": "$name"
              },
              {
                "type": "text",
                "content": "$role"
              },
              {
                "type": "text",
                "content": "$email"
              }
            ]
          }
        ],
        "pages": [
          {
            "name": "Team",
            "path": "/team",
            "sections": [
              {
                "block": "user-card",
                "vars": {
                  "name": "John Doe",
                  "role": "Developer",
                  "email": "john@example.com"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-user-card\" class=\"card\"><h3>John Doe</h3><span>Developer</span><span>john@example.com</span></div>",
        "assertions": [
          "vars object: Data container for template substitution",
          "vars.name='John Doe' → replaces $name in h3",
          "vars.role='Developer' → replaces $role in first span",
          "vars.email='john@example.com' → replaces $email in second span",
          "All template variables receive data from vars object",
          "vars provides complete dataset for single block instance"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-006",
      "given": "vars property names in camelCase",
      "when": "vars property names match ^[a-zA-Z][a-zA-Z0-9]*$ pattern",
      "then": "it should validate JavaScript naming convention for variables",
      "validation": {
        "setup": {
          "validVars": {
            "color": "blue",
            "iconName": "star",
            "titleText": "Hello",
            "isActive": true
          },
          "invalidVars": {
            "text-color": "invalid",
            "1stValue": "invalid",
            "": "invalid"
          }
        },
        "assertions": [
          "Valid: color, iconName, titleText, isActive (camelCase)",
          "Invalid: 'text-color' (hyphen), '1stValue' (starts with digit), '' (empty)",
          "Pattern enforces JavaScript variable naming",
          "Consistent with $variable placeholders in templates"
        ]
      },
      "application": {
        "blocks": [
          {
            "name": "demo-block",
            "type": "div",
            "props": {
              "className": "$color icon-$iconName"
            },
            "children": [
              {
                "type": "text",
                "content": "$titleText"
              }
            ]
          }
        ],
        "pages": [
          {
            "name": "Demo",
            "path": "/demo",
            "sections": [
              {
                "block": "demo-block",
                "vars": {
                  "color": "blue",
                  "iconName": "star",
                  "titleText": "Hello",
                  "isActive": true
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-demo-block\" class=\"blue icon-star\"><span>Hello</span></div>",
        "assertions": [
          "Variable naming: ^[a-zA-Z][a-zA-Z0-9]*$ (JavaScript convention)",
          "Valid: 'color', 'iconName', 'titleText', 'isActive' (camelCase)",
          "Must start with letter: [a-zA-Z]",
          "Can contain: letters and digits only",
          "Invalid: 'text-color' (hyphen not allowed), '1stValue' (starts with digit), '' (empty)",
          "Matches $variable placeholders in templates ($color, $iconName, etc.)"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-007",
      "given": "vars property values",
      "when": "values are string, number, or boolean",
      "then": "it should substitute primitive data types into template",
      "application": {
        "blocks": [
          {
            "name": "settings-toggle",
            "type": "div",
            "props": {
              "className": "setting-$priority"
            },
            "children": [
              {
                "type": "text",
                "content": "$label"
              },
              {
                "type": "input",
                "props": {
                  "type": "checkbox",
                  "checked": "$enabled"
                }
              },
              {
                "type": "text",
                "content": "Max: $maxValue"
              }
            ]
          }
        ],
        "pages": [
          {
            "name": "Settings",
            "path": "/settings",
            "sections": [
              {
                "block": "settings-toggle",
                "vars": {
                  "priority": "high",
                  "label": "Enable feature",
                  "enabled": true,
                  "maxValue": 100
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-settings-toggle\" class=\"setting-high\"><span>Enable feature</span><input type=\"checkbox\" checked /><span>Max: 100</span></div>",
        "assertions": [
          "Primitive data types: string, number, boolean",
          "String: priority='high' → className='setting-high'",
          "String: label='Enable feature' → text content 'Enable feature'",
          "Boolean: enabled=true → checked attribute present on input",
          "Number: maxValue=100 → renders as '100' in text 'Max: 100'",
          "All primitive types supported for variable substitution"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-008",
      "given": "icon-badge reference example",
      "when": "block is 'icon-badge' with vars: color='orange', icon='users', text='6 à 15 personnes'",
      "then": "it should render badge with orange color, users icon, and French text",
      "application": {
        "blocks": [
          {
            "name": "icon-badge",
            "type": "badge",
            "props": {
              "color": "$color"
            },
            "children": [
              {
                "type": "icon",
                "props": {
                  "name": "$icon",
                  "size": 4
                }
              },
              {
                "type": "text",
                "props": {
                  "level": "span"
                },
                "content": "$text"
              }
            ]
          }
        ],
        "pages": [
          {
            "name": "Workshop",
            "path": "/workshop",
            "sections": [
              {
                "block": "icon-badge",
                "vars": {
                  "color": "orange",
                  "icon": "users",
                  "text": "6 à 15 personnes"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-icon-badge\" data-color=\"orange\"><svg data-testid=\"icon-users\" width=\"16\" height=\"16\"></svg><span>6 à 15 personnes</span></div>",
        "assertions": [
          "Real-world example: icon-badge for workshop capacity",
          "vars.color='orange' → data-color='orange'",
          "vars.icon='users' → data-testid='icon-users', size 16x16 (4*4px)",
          "vars.text='6 à 15 personnes' → French UTF-8 text with 'à'",
          "All 3 variables substituted correctly",
          "Demonstrates multi-language content support"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-009",
      "given": "section-header reference example",
      "when": "block is 'section-header' with vars: titleColor='pourpre', title='notre mission', subtitle='...'",
      "then": "it should render section header with purple title and French content",
      "application": {
        "blocks": [
          {
            "name": "section-header",
            "type": "container",
            "props": {
              "className": "text-center mb-12"
            },
            "children": [
              {
                "type": "text",
                "props": {
                  "level": "h2",
                  "className": "text-$titleColor text-4xl mb-4"
                },
                "content": "$title"
              },
              {
                "type": "text",
                "props": {
                  "level": "p"
                },
                "content": "$subtitle"
              }
            ]
          }
        ],
        "pages": [
          {
            "name": "Mission",
            "path": "/mission",
            "sections": [
              {
                "block": "section-header",
                "vars": {
                  "titleColor": "pourpre",
                  "title": "notre mission",
                  "subtitle": "Rendre la culture du consentement accessible à tous"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-section-header\" class=\"text-center mb-12\"><h2 class=\"text-pourpre text-4xl mb-4\">notre mission</h2><p>Rendre la culture du consentement accessible à tous</p></div>",
        "assertions": [
          "Real-world example: section-header for mission page (French)",
          "Container: class='text-center mb-12'",
          "H2: class includes 'text-pourpre' (purple in French)",
          "H2: lowercase title 'notre mission'",
          "Paragraph: subtitle about consent culture (French UTF-8)",
          "Multi-language support: French text with lowercase styling"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-010",
      "given": "variable substitution mechanism",
      "when": "vars values replace $variable placeholders in block template",
      "then": "it should transform abstract template into concrete rendered component",
      "application": {
        "blocks": [
          {
            "name": "alert",
            "type": "div",
            "props": {
              "className": "alert alert-$variant"
            },
            "content": "$message"
          }
        ],
        "pages": [
          {
            "name": "Dashboard",
            "path": "/dashboard",
            "sections": [
              {
                "block": "alert",
                "vars": {
                  "variant": "success",
                  "message": "Saved successfully!"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-alert\" class=\"alert alert-success\">Saved successfully!</div>",
        "assertions": [
          "Substitution mechanism: $variable → actual value",
          "Step 1: Find placeholders ($variant, $message)",
          "Step 2: Look up in vars (variant='success', message='Saved successfully!')",
          "Step 3: Replace 'alert-$variant' → 'alert-success'",
          "Step 4: Replace '$message' → 'Saved successfully!'",
          "Final DOM: NO $ symbols, only concrete values",
          "Abstract template → Concrete component transformation"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-011",
      "given": "block reference for template instantiation",
      "when": "reference creates instance of block with specific data",
      "then": "it should enable same template to generate different instances",
      "application": {
        "blocks": [
          {
            "name": "team-member",
            "type": "card",
            "children": [
              {
                "type": "img",
                "props": {
                  "src": "$photo",
                  "alt": "$name"
                }
              },
              {
                "type": "text",
                "props": {
                  "level": "h4"
                },
                "content": "$name"
              },
              {
                "type": "text",
                "content": "$position"
              }
            ]
          }
        ],
        "pages": [
          {
            "name": "Team",
            "path": "/team",
            "sections": [
              {
                "block": "team-member",
                "vars": {
                  "photo": "/alice.jpg",
                  "name": "Alice",
                  "position": "CEO"
                }
              },
              {
                "block": "team-member",
                "vars": {
                  "photo": "/bob.jpg",
                  "name": "Bob",
                  "position": "CTO"
                }
              },
              {
                "block": "team-member",
                "vars": {
                  "photo": "/carol.jpg",
                  "name": "Carol",
                  "position": "Designer"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-team-member-0\" class=\"card\"><img src=\"/alice.jpg\" alt=\"Alice\" /><h4>Alice</h4><span>CEO</span></div><div data-testid=\"block-team-member-1\" class=\"card\"><img src=\"/bob.jpg\" alt=\"Bob\" /><h4>Bob</h4><span>CTO</span></div><div data-testid=\"block-team-member-2\" class=\"card\"><img src=\"/carol.jpg\" alt=\"Carol\" /><h4>Carol</h4><span>Designer</span></div>",
        "assertions": [
          "Template instantiation: 1 template → 3 instances",
          "Instance 0: Alice (CEO), /alice.jpg, data-testid='block-team-member-0'",
          "Instance 1: Bob (CTO), /bob.jpg, data-testid='block-team-member-1'",
          "Instance 2: Carol (Designer), /carol.jpg, data-testid='block-team-member-2'",
          "Each instance has unique data but identical structure",
          "Data-driven components: Same template, different content",
          "Unique testid suffixes enable individual testing"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-REFERENCE-012",
      "given": "block reference for single source of truth",
      "when": "multiple references point to same block template",
      "then": "it should maintain structural consistency while varying data",
      "application": {
        "blocks": [
          {
            "name": "feature-item",
            "type": "div",
            "props": {
              "className": "feature flex gap-4"
            },
            "children": [
              {
                "type": "icon",
                "props": {
                  "name": "$icon",
                  "color": "blue"
                }
              },
              {
                "type": "div",
                "children": [
                  {
                    "type": "text",
                    "props": {
                      "level": "h5"
                    },
                    "content": "$title"
                  },
                  {
                    "type": "text",
                    "content": "$description"
                  }
                ]
              }
            ]
          }
        ],
        "pages": [
          {
            "name": "Home",
            "path": "/",
            "sections": [
              {
                "block": "feature-item",
                "vars": {
                  "icon": "shield",
                  "title": "Secure",
                  "description": "Enterprise-grade security"
                }
              },
              {
                "block": "feature-item",
                "vars": {
                  "icon": "zap",
                  "title": "Fast",
                  "description": "Lightning-fast performance"
                }
              }
            ]
          },
          {
            "name": "Pricing",
            "path": "/pricing",
            "sections": [
              {
                "block": "feature-item",
                "vars": {
                  "icon": "dollar",
                  "title": "Affordable",
                  "description": "Competitive pricing"
                }
              }
            ]
          }
        ],
        "expectedDOM": "<div data-testid=\"block-feature-item-0\" class=\"feature flex gap-4\"><svg data-testid=\"icon-shield\" data-color=\"blue\"></svg><div><h5>Secure</h5><span>Enterprise-grade security</span></div></div>",
        "assertions": [
          "Single source of truth: 1 template → 3 instances across 2 pages",
          "All instances share identical structure: flex container + icon + text",
          "All instances share identical styling: class='feature flex gap-4', icon color='blue'",
          "Only data varies: icon name, title, description",
          "Modify 1 template → ALL instances update automatically",
          "Structural consistency guaranteed: impossible for instances to diverge",
          "Cross-page consistency: Same block used on Home and Pricing pages"
        ]
      }
    },
    {
      "id": "APP-BLOCKS-BLOCK-REFERENCE-REGRESSION-001",
      "given": "complete application configuration with all features",
      "when": "user completes full workflow",
      "then": "user can complete full reference workflow"
    }
  ]
}
