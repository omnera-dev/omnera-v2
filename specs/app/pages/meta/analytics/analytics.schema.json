{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "analytics.schema.json",
  "title": "Analytics Configuration",
  "description": "Configuration for analytics providers",
  "type": "object",
  "properties": {
    "providers": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "enum": ["google", "plausible", "matomo", "fathom", "posthog", "mixpanel"],
            "description": "Analytics provider name"
          },
          "enabled": {
            "type": "boolean",
            "default": true,
            "description": "Whether this provider is enabled"
          },
          "scripts": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "src": {
                  "type": "string",
                  "format": "uri",
                  "description": "Script source URL"
                },
                "async": {
                  "type": "boolean",
                  "default": true,
                  "description": "Load script asynchronously"
                },
                "defer": {
                  "type": "boolean",
                  "description": "Defer script execution"
                }
              },
              "required": ["src"]
            }
          },
          "initScript": {
            "type": "string",
            "description": "Inline JavaScript to initialize the analytics"
          },
          "dnsPrefetch": {
            "type": "string",
            "format": "uri",
            "description": "Domain to DNS prefetch for this provider"
          },
          "config": {
            "type": "object",
            "description": "Provider-specific configuration",
            "additionalProperties": true
          }
        },
        "required": ["name"],
        "additionalProperties": false
      }
    }
  },
  "required": ["providers"],
  "additionalProperties": false,
  "examples": [
    {
      "providers": [
        {
          "name": "plausible",
          "enabled": true,
          "scripts": [
            {
              "src": "https://plausible.io/js/script.js",
              "async": true
            }
          ],
          "dnsPrefetch": "https://plausible.io"
        }
      ]
    }
  ],
  "x-specs": [
    {
      "id": "APP-PAGES-ANALYTICS-001",
      "given": "analytics with providers array",
      "when": "providers contains analytics configurations",
      "then": "it should support multiple analytics providers",
      "validation": {
        "setup": {
          "analytics": {
            "providers": [
              {
                "name": "plausible",
                "enabled": true
              },
              {
                "name": "google",
                "enabled": true
              }
            ]
          }
        },
        "assertions": [
          "providers: array (required)",
          "Each provider: object with name + enabled",
          "Multiple providers supported simultaneously"
        ]
      },
      "application": {
        "analytics": {
          "providers": [
            {
              "name": "plausible",
              "enabled": true,
              "scripts": [
                {
                  "src": "https://plausible.io/js/script.js",
                  "async": true
                }
              ]
            },
            {
              "name": "google",
              "enabled": true,
              "scripts": [
                {
                  "src": "https://www.googletagmanager.com/gtag/js?id=G-XXXXX",
                  "async": true
                }
              ],
              "config": {
                "trackingId": "G-XXXXX"
              }
            }
          ]
        },
        "expectedDOM": "<head><!-- Plausible Analytics --><script data-testid=\"analytics-plausible\" src=\"https://plausible.io/js/script.js\" async></script><!-- Google Analytics --><script data-testid=\"analytics-google\" src=\"https://www.googletagmanager.com/gtag/js?id=G-XXXXX\" async></script></head>",
        "assertions": [
          "Multiple analytics providers loaded simultaneously",
          "Each provider: independent script tags",
          "Common pattern: privacy-friendly (Plausible) + full-featured (Google)",
          "Use case: transition period, A/B testing, compliance"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-002",
      "given": "analytics provider with name enum",
      "when": "name is one of: google, plausible, matomo, fathom, posthog, mixpanel",
      "then": "it should support 6 analytics providers",
      "validation": {
        "setup": {
          "providers": ["google", "plausible", "matomo", "fathom", "posthog", "mixpanel"]
        },
        "assertions": [
          "name: enum (6 values)",
          "Covers most popular analytics platforms",
          "Mix: privacy-focused + full-featured"
        ]
      },
      "application": {
        "providerTypes": {
          "google": "Full-featured, free, most popular (60% market share)",
          "plausible": "Privacy-focused, GDPR-compliant, no cookies",
          "matomo": "Open-source, self-hosted, privacy-focused",
          "fathom": "Privacy-first, simple, GDPR-compliant",
          "posthog": "Product analytics, session replay, feature flags",
          "mixpanel": "Product analytics, funnel analysis, cohort analysis"
        },
        "assertions": [
          "6 providers cover 90% of analytics use cases",
          "Privacy-focused: plausible, matomo, fathom (GDPR-friendly)",
          "Full-featured: google (free), posthog, mixpanel (product analytics)",
          "Enum validation prevents typos"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-003",
      "given": "analytics provider with enabled toggle",
      "when": "enabled is true or false",
      "then": "it should allow enabling/disabling provider",
      "validation": {
        "setup": {
          "providers": [
            {
              "name": "google",
              "enabled": true
            },
            {
              "name": "plausible",
              "enabled": false
            }
          ]
        },
        "assertions": [
          "enabled: boolean (default: true)",
          "Allows dynamic provider control",
          "Use case: testing, compliance, feature flags"
        ]
      },
      "application": {
        "analytics": {
          "providers": [
            {
              "name": "google",
              "enabled": true,
              "scripts": [
                {
                  "src": "https://www.googletagmanager.com/gtag/js?id=G-XXXXX"
                }
              ]
            },
            {
              "name": "plausible",
              "enabled": false,
              "scripts": [
                {
                  "src": "https://plausible.io/js/script.js"
                }
              ]
            }
          ]
        },
        "expectedDOM": "<head><!-- Google Analytics (enabled) --><script data-testid=\"analytics-google\" src=\"https://www.googletagmanager.com/gtag/js?id=G-XXXXX\"></script><!-- Plausible Analytics (disabled, not rendered) --></head>",
        "assertions": [
          "enabled: true → scripts rendered",
          "enabled: false → scripts NOT rendered",
          "Use cases: disable in dev environment, conditional tracking, user consent",
          "Toggle without removing configuration"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-004",
      "given": "analytics provider with scripts array",
      "when": "scripts contains external script configurations",
      "then": "it should load provider scripts",
      "validation": {
        "setup": {
          "provider": {
            "name": "plausible",
            "scripts": [
              {
                "src": "https://plausible.io/js/script.js",
                "async": true
              }
            ]
          }
        },
        "assertions": [
          "scripts: array of script objects",
          "Each script: src (required) + async/defer (optional)",
          "Multiple scripts per provider supported"
        ]
      },
      "application": {
        "provider": {
          "name": "google",
          "scripts": [
            {
              "src": "https://www.googletagmanager.com/gtag/js?id=G-XXXXX",
              "async": true
            }
          ]
        },
        "expectedDOM": "<head><script data-testid=\"analytics-script-0\" src=\"https://www.googletagmanager.com/gtag/js?id=G-XXXXX\" async></script></head>",
        "assertions": [
          "Scripts loaded from external CDN",
          "src: absolute URL (https://)",
          "Common pattern: single script per provider",
          "Some providers need multiple scripts (e.g., Tag Manager + gtag.js)"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-005",
      "given": "analytics provider script with async",
      "when": "async is true for non-blocking load",
      "then": "it should load script asynchronously",
      "validation": {
        "setup": {
          "script": {
            "src": "https://plausible.io/js/script.js",
            "async": true
          }
        },
        "assertions": [
          "async: boolean (default: true)",
          "Non-blocking script load",
          "Best practice: always use async for analytics"
        ]
      },
      "application": {
        "script": {
          "src": "https://plausible.io/js/script.js",
          "async": true
        },
        "expectedDOM": "<script data-testid=\"analytics-script\" src=\"https://plausible.io/js/script.js\" async></script>",
        "behavior": {
          "async": "Script loads in parallel, doesn't block page render",
          "performance": "Page interactive faster (no render blocking)",
          "execution": "Script runs as soon as it's downloaded"
        },
        "assertions": [
          "async attribute prevents render blocking",
          "Page loads faster (no waiting for analytics)",
          "Best practice: always async for analytics (non-critical)",
          "Default: async = true"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-006",
      "given": "analytics provider with initScript",
      "when": "initScript contains inline JavaScript for initialization",
      "then": "it should execute provider initialization code",
      "validation": {
        "setup": {
          "provider": {
            "name": "google",
            "scripts": [
              {
                "src": "https://www.googletagmanager.com/gtag/js?id=G-XXXXX"
              }
            ],
            "initScript": "window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XXXXX');"
          }
        },
        "assertions": [
          "initScript: string (optional)",
          "Inline JavaScript for provider initialization",
          "Runs after external scripts load"
        ]
      },
      "application": {
        "provider": {
          "name": "google",
          "scripts": [
            {
              "src": "https://www.googletagmanager.com/gtag/js?id=G-XXXXX",
              "async": true
            }
          ],
          "initScript": "window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XXXXX');",
          "config": {
            "trackingId": "G-XXXXX"
          }
        },
        "expectedDOM": "<head><!-- External script --><script data-testid=\"analytics-script\" src=\"https://www.googletagmanager.com/gtag/js?id=G-XXXXX\" async></script><!-- Initialization script --><script data-testid=\"analytics-init\">window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XXXXX');</script></head>",
        "execution": {
          "step1": "External script loads (async)",
          "step2": "initScript runs to configure provider",
          "step3": "Analytics starts tracking"
        },
        "assertions": [
          "initScript: inline <script> tag (no src)",
          "Common pattern: external library + inline config",
          "Example: Google Analytics needs gtag() function setup",
          "Allows dynamic configuration (tracking ID from config)"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-007",
      "given": "analytics provider with dnsPrefetch",
      "when": "dnsPrefetch specifies provider domain",
      "then": "it should optimize DNS resolution for provider",
      "validation": {
        "setup": {
          "provider": {
            "name": "plausible",
            "dnsPrefetch": "https://plausible.io"
          }
        },
        "assertions": [
          "dnsPrefetch: URI string (optional)",
          "Optimizes DNS lookup before script load",
          "Performance optimization"
        ]
      },
      "application": {
        "provider": {
          "name": "plausible",
          "scripts": [
            {
              "src": "https://plausible.io/js/script.js",
              "async": true
            }
          ],
          "dnsPrefetch": "https://plausible.io"
        },
        "expectedDOM": "<head><!-- DNS Prefetch (before script) --><link data-testid=\"dns-prefetch-plausible\" rel=\"dns-prefetch\" href=\"https://plausible.io\" /><!-- Script tag --><script data-testid=\"analytics-script\" src=\"https://plausible.io/js/script.js\" async></script></head>",
        "performance": {
          "withoutDNSPrefetch": "DNS lookup happens when script tag is encountered (~50-200ms delay)",
          "withDNSPrefetch": "DNS lookup starts early (parallel), script loads faster",
          "improvement": "~50-100ms faster script load"
        },
        "assertions": [
          "DNS Prefetch: <link rel=\"dns-prefetch\"> before script tags",
          "Speeds up external script loading",
          "Best practice for third-party analytics",
          "Small performance win (~50-100ms)"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-008",
      "given": "analytics provider with config object",
      "when": "config contains provider-specific settings",
      "then": "it should pass configuration to provider",
      "validation": {
        "setup": {
          "provider": {
            "name": "google",
            "config": {
              "trackingId": "G-XXXXX",
              "anonymizeIp": true,
              "cookieFlags": "SameSite=None;Secure"
            }
          }
        },
        "assertions": [
          "config: object (optional, provider-specific)",
          "additionalProperties: true (any config)",
          "Passed to provider initialization"
        ]
      },
      "application": {
        "provider": {
          "name": "posthog",
          "config": {
            "apiKey": "phc_XXXXX",
            "apiHost": "https://app.posthog.com",
            "autocapture": true,
            "capturePageview": true,
            "sessionRecording": {
              "enabled": true,
              "maskAllInputs": true
            }
          }
        },
        "initialization": {
          "code": "posthog.init('phc_XXXXX', { api_host: 'https://app.posthog.com', autocapture: true, capture_pageview: true, session_recording: { maskAllInputs: true } })"
        },
        "assertions": [
          "config object passed to provider initialization",
          "Each provider: different config schema",
          "Examples: tracking IDs, privacy settings, features",
          "Flexible: additionalProperties allows any provider-specific config"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-009",
      "given": "analytics with Google Analytics provider",
      "when": "name is 'google' with tracking ID in config",
      "then": "it should configure Google Analytics",
      "validation": {
        "setup": {
          "provider": {
            "name": "google",
            "enabled": true,
            "config": {
              "trackingId": "G-XXXXX"
            }
          }
        },
        "assertions": [
          "name: 'google'",
          "config.trackingId: Google Analytics 4 ID (G-XXXXX)",
          "Most popular analytics (60% market share)"
        ]
      },
      "application": {
        "provider": {
          "name": "google",
          "enabled": true,
          "scripts": [
            {
              "src": "https://www.googletagmanager.com/gtag/js?id=G-ABC123XYZ",
              "async": true
            }
          ],
          "initScript": "window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ABC123XYZ');",
          "dnsPrefetch": "https://www.googletagmanager.com",
          "config": {
            "trackingId": "G-ABC123XYZ"
          }
        },
        "expectedDOM": "<head><link rel=\"dns-prefetch\" href=\"https://www.googletagmanager.com\" /><script data-testid=\"google-analytics-script\" src=\"https://www.googletagmanager.com/gtag/js?id=G-ABC123XYZ\" async></script><script data-testid=\"google-analytics-init\">window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ABC123XYZ');</script></head>",
        "tracking": {
          "pageviews": "Automatic",
          "events": "Custom via gtag('event', 'event_name')",
          "conversions": "Goal tracking, ecommerce",
          "reports": "Real-time, acquisition, behavior, conversions"
        },
        "assertions": [
          "Google Analytics 4 (GA4) configuration",
          "Most popular: 60% of top 10k websites use GA",
          "Free, full-featured, integrates with Google Ads",
          "Tracking ID format: G-XXXXXXXXX"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-010",
      "given": "analytics with Plausible provider",
      "when": "name is 'plausible' with domain config",
      "then": "it should configure privacy-friendly Plausible analytics",
      "validation": {
        "setup": {
          "provider": {
            "name": "plausible",
            "enabled": true,
            "config": {
              "domain": "example.com"
            }
          }
        },
        "assertions": [
          "name: 'plausible'",
          "config.domain: website domain",
          "Privacy-focused: GDPR-compliant, no cookies"
        ]
      },
      "application": {
        "provider": {
          "name": "plausible",
          "enabled": true,
          "scripts": [
            {
              "src": "https://plausible.io/js/script.js",
              "async": true,
              "defer": true
            }
          ],
          "dnsPrefetch": "https://plausible.io",
          "config": {
            "domain": "example.com",
            "dataDomain": "example.com"
          }
        },
        "expectedDOM": "<head><link rel=\"dns-prefetch\" href=\"https://plausible.io\" /><script data-testid=\"plausible-analytics\" src=\"https://plausible.io/js/script.js\" data-domain=\"example.com\" async defer></script></head>",
        "privacy": {
          "cookies": "No cookies (GDPR-friendly)",
          "pii": "No personal data collected",
          "lightweight": "< 1KB script size (vs 45KB for GA)",
          "compliant": "GDPR, CCPA, PECR compliant by default"
        },
        "assertions": [
          "Plausible: privacy-first analytics",
          "No cookies, no PII, GDPR-compliant",
          "Lightweight: < 1KB (45x smaller than Google Analytics)",
          "Simple: pageviews, sources, devices",
          "Paid service: $9/month (10k pageviews)"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-011",
      "given": "analytics with multiple providers",
      "when": "providers array contains [plausible, google]",
      "then": "it should support multi-provider analytics",
      "validation": {
        "setup": {
          "analytics": {
            "providers": [
              {
                "name": "plausible",
                "enabled": true
              },
              {
                "name": "google",
                "enabled": true
              }
            ]
          }
        },
        "assertions": [
          "Multiple providers: array of 2+ providers",
          "Each provider independent",
          "Common: privacy + full-featured"
        ]
      },
      "application": {
        "analytics": {
          "providers": [
            {
              "name": "plausible",
              "enabled": true,
              "scripts": [
                {
                  "src": "https://plausible.io/js/script.js",
                  "async": true
                }
              ],
              "config": {
                "domain": "example.com"
              }
            },
            {
              "name": "google",
              "enabled": true,
              "scripts": [
                {
                  "src": "https://www.googletagmanager.com/gtag/js?id=G-XXXXX",
                  "async": true
                }
              ],
              "initScript": "window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XXXXX');",
              "config": {
                "trackingId": "G-XXXXX"
              }
            }
          ]
        },
        "expectedDOM": "<head><!-- Plausible Analytics --><link rel=\"dns-prefetch\" href=\"https://plausible.io\" /><script data-testid=\"analytics-plausible\" src=\"https://plausible.io/js/script.js\" data-domain=\"example.com\" async></script><!-- Google Analytics --><link rel=\"dns-prefetch\" href=\"https://www.googletagmanager.com\" /><script data-testid=\"analytics-google-script\" src=\"https://www.googletagmanager.com/gtag/js?id=G-XXXXX\" async></script><script data-testid=\"analytics-google-init\">window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XXXXX');</script></head>",
        "useCases": {
          "transition": "Migrating from Google to Plausible (run both temporarily)",
          "compliance": "Plausible for EU (GDPR), Google for rest",
          "comparison": "Compare data quality between providers",
          "fallback": "Redundancy if one provider fails"
        },
        "assertions": [
          "Multiple providers run simultaneously",
          "Each tracks independently (duplicate data)",
          "Common: privacy-friendly + full-featured analytics",
          "Use case: transition period, compliance, redundancy"
        ]
      }
    },
    {
      "id": "APP-PAGES-ANALYTICS-012",
      "given": "analytics provider with PostHog",
      "when": "name is 'posthog' for product analytics",
      "then": "it should configure event tracking and feature flags",
      "validation": {
        "setup": {
          "provider": {
            "name": "posthog",
            "enabled": true,
            "config": {
              "apiKey": "phc_XXXXX",
              "apiHost": "https://app.posthog.com"
            }
          }
        },
        "assertions": [
          "name: 'posthog'",
          "config.apiKey: PostHog project API key",
          "Product analytics: events, funnels, cohorts, session replay"
        ]
      },
      "application": {
        "provider": {
          "name": "posthog",
          "enabled": true,
          "scripts": [
            {
              "src": "https://app.posthog.com/static/array.js",
              "async": true
            }
          ],
          "initScript": "!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(\\\".\\\");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement(\\\"script\\\")).type=\\\"text/javascript\\\",p.async=!0,p.src=s.api_host+\\\"/static/array.js\\\",(r=t.getElementsByTagName(\\\"script\\\")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a=\\\"posthog\\\",u.people=u.people||[],u.toString=function(t){var e=\\\"posthog\\\";return\\\"posthog\\\"!==a&&(e+=\\\".\\\"+a),t||(e+=\\\" (stub)\\\"),e},u.people.toString=function(){return u.toString(1)+\\\".people (stub)\\\"},o=\\\"capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags\\\".split(\\\" \\\"),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]); posthog.init('phc_XXXXX',{api_host:'https://app.posthog.com'})",
          "dnsPrefetch": "https://app.posthog.com",
          "config": {
            "apiKey": "phc_ABC123XYZ",
            "apiHost": "https://app.posthog.com",
            "autocapture": true,
            "capturePageview": true,
            "sessionRecording": {
              "enabled": true,
              "maskAllInputs": true,
              "maskAllText": false
            }
          }
        },
        "expectedDOM": "<head><link rel=\"dns-prefetch\" href=\"https://app.posthog.com\" /><script data-testid=\"posthog-script\" src=\"https://app.posthog.com/static/array.js\" async></script><script data-testid=\"posthog-init\">posthog.init('phc_ABC123XYZ',{api_host:'https://app.posthog.com',autocapture:true,capture_pageview:true,session_recording:{enabled:true,maskAllInputs:true}})</script></head>",
        "features": {
          "eventTracking": "Automatic + custom events (posthog.capture('event_name'))",
          "funnels": "Conversion funnel analysis",
          "cohorts": "User segmentation",
          "sessionReplay": "Record user sessions with privacy controls",
          "featureFlags": "A/B testing, gradual rollouts (posthog.isFeatureEnabled('flag'))",
          "heatmaps": "Click maps, scroll maps"
        },
        "assertions": [
          "PostHog: product analytics platform",
          "Features: events, funnels, cohorts, session replay, feature flags",
          "Open-source, self-hosted or cloud",
          "Developer-friendly: extensive API, feature flags",
          "Pricing: Free (1M events/month), paid plans from $0.00031/event"
        ]
      }
    },
    {
      "id": "APP-PAGES-META-ANALYTICS-ANALYTICS-REGRESSION-001",
      "given": "complete application configuration with all features",
      "when": "user completes full workflow",
      "then": "user can complete full analytics workflow"
    }
  ]
}
