name: TDD Queue - PR Monitor & Auto-Retry

# This workflow monitors TDD automation PRs for two issues:
# 1. PRs stuck in open state despite passing checks (missing auto-merge)
# 2. PRs with failed tests that need automatic retry
#
# It automatically:
# - Enables auto-merge for stuck PRs
# - Triggers @claude retry for test failures (up to 3 times)
# - Tracks retry attempts to prevent infinite loops

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual triggering for testing

concurrency:
  group: tdd-stuck-pr-monitor
  cancel-in-progress: false

env:
  MAX_CODE_RETRIES: 3  # Max retries for code/test failures

jobs:
  monitor-stuck-prs:
    name: Monitor and Fix PRs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Find and fix stuck PRs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Scanning for stuck PRs..."

          # Get all open tdd-automation PRs
          OPEN_PRS=$(gh pr list \
            --repo sovrium/sovrium \
            --label tdd-automation \
            --state open \
            --json number,autoMergeRequest,mergeable,statusCheckRollup,createdAt,headRefName,mergeStateStatus \
            --jq '.[]')

          if [ -z "$OPEN_PRS" ]; then
            echo "‚úÖ No open tdd-automation PRs found"
            exit 0
          fi

          # Process each PR
          echo "$OPEN_PRS" | jq -c '.' | while IFS= read -r PR; do
            PR_NUMBER=$(echo "$PR" | jq -r '.number')
            AUTO_MERGE=$(echo "$PR" | jq -r '.autoMergeRequest')
            MERGEABLE=$(echo "$PR" | jq -r '.mergeable')
            CREATED_AT=$(echo "$PR" | jq -r '.createdAt')
            HEAD_REF=$(echo "$PR" | jq -r '.headRefName')
            MERGE_STATE=$(echo "$PR" | jq -r '.mergeStateStatus')

            echo ""
            echo "üìã Checking PR #$PR_NUMBER (branch: $HEAD_REF)"
            echo "   Created: $CREATED_AT"
            echo "   Mergeable: $MERGEABLE"
            echo "   Merge State: $MERGE_STATE"
            echo "   Auto-merge: $([ "$AUTO_MERGE" = "null" ] && echo "‚ùå NOT ENABLED" || echo "‚úÖ Enabled")"

            # Skip if auto-merge is already enabled
            if [ "$AUTO_MERGE" != "null" ]; then
              echo "   ‚úÖ Auto-merge already enabled, skipping"
              continue
            fi

            # Track if we updated the branch
            BRANCH_UPDATED="false"

            # Check if branch needs updating (behind main)
            if [ "$MERGE_STATE" = "BEHIND" ] || [ "$MERGEABLE" = "CONFLICTING" ]; then
              echo "   üîÑ Branch is behind main or has conflicts, attempting to update..."

              # Try to update the branch with main using GitHub API
              UPDATE_RESULT=$(gh api \
                --method PUT \
                "/repos/sovrium/sovrium/pulls/$PR_NUMBER/update-branch" \
                2>&1 || echo "FAILED")

              if [ "$UPDATE_RESULT" != "FAILED" ]; then
                echo "   ‚úÖ Branch update initiated successfully"
                BRANCH_UPDATED="true"

                # Wait for GitHub to complete the update
                sleep 10

                # Re-fetch PR status after update
                UPDATED_PR=$(gh pr view "$PR_NUMBER" --repo sovrium/sovrium --json mergeable,mergeStateStatus)
                MERGEABLE=$(echo "$UPDATED_PR" | jq -r '.mergeable')
                MERGE_STATE=$(echo "$UPDATED_PR" | jq -r '.mergeStateStatus')

                echo "   üìä New status after update: Mergeable=$MERGEABLE, MergeState=$MERGE_STATE"
              else
                echo "   ‚ö†Ô∏è  Failed to update branch (may require manual intervention for conflicts)"
                echo "   Error: $UPDATE_RESULT"
              fi
            fi

            # Skip if still not mergeable after update attempt
            if [ "$MERGEABLE" != "MERGEABLE" ]; then
              echo "   ‚ö†Ô∏è  Not mergeable (status: $MERGEABLE), skipping"
              continue
            fi

            # Check if all required checks are passing
            CHECKS=$(echo "$PR" | jq -r '.statusCheckRollup[]? | select(.name == "Test" or .name == "CodeQL") | select(.conclusion == "SUCCESS" or .conclusion == "SKIPPED") | .name' | wc -l | xargs)

            if [ "$CHECKS" -lt 1 ]; then
              echo "   ‚è≥ CI checks not complete yet, skipping"
              continue
            fi

            # Calculate PR age in minutes
            NOW=$(date +%s)
            CREATED_TIMESTAMP=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED_AT" +%s 2>/dev/null || echo $NOW)
            AGE_MINUTES=$(( ($NOW - $CREATED_TIMESTAMP) / 60 ))

            # Only enable auto-merge if PR is older than 5 minutes
            # This gives Claude Code time to enable it manually
            if [ $AGE_MINUTES -lt 5 ]; then
              echo "   ‚è≥ PR is only $AGE_MINUTES minutes old, waiting for Claude Code to enable auto-merge"
              continue
            fi

            # Enable auto-merge for stuck PR
            echo "   üîß STUCK PR DETECTED! Enabling auto-merge..."
            if gh pr merge "$PR_NUMBER" --auto --squash --repo sovrium/sovrium; then
              echo "   ‚úÖ Auto-merge enabled successfully for PR #$PR_NUMBER"

              # Add a comment explaining what happened
              COMMENT_BODY="ü§ñ **Stuck PR Monitor**

              This PR was stuck in an open state despite having all checks passing and being mergeable. Auto-merge has been automatically enabled.

              **Actions taken:**
              - $([ "$BRANCH_UPDATED" = "true" ] && echo "‚úÖ Updated branch with latest main" || echo "Branch was already up to date")
              - ‚úÖ Enabled auto-merge

              **Details:**
              - PR age: $AGE_MINUTES minutes
              - Mergeable status: $MERGEABLE
              - Merge state: $MERGE_STATE
              - CI checks: Passing

              The PR will now merge automatically when all requirements are met."

              gh pr comment "$PR_NUMBER" --repo sovrium/sovrium --body "$COMMENT_BODY"
            else
              echo "   ‚ùå Failed to enable auto-merge for PR #$PR_NUMBER"
            fi
          done

          echo ""
          echo "‚úÖ Stuck PR monitoring complete"

      - name: Auto-retry failed tests
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîÑ Checking for PRs with failed tests..."

          # Get all open tdd-automation PRs with their status
          OPEN_PRS=$(gh pr list \
            --repo sovrium/sovrium \
            --label tdd-automation \
            --state open \
            --json number,labels,statusCheckRollup,headRefName,updatedAt,title \
            --jq '.[]')

          if [ -z "$OPEN_PRS" ]; then
            echo "‚úÖ No open tdd-automation PRs found"
            exit 0
          fi

          RETRY_TRIGGERED_COUNT=0
          FAILED_COUNT=0

          # Process each PR for test failures
          echo "$OPEN_PRS" | jq -c '.' | while IFS= read -r PR; do
            PR_NUMBER=$(echo "$PR" | jq -r '.number')
            TITLE=$(echo "$PR" | jq -r '.title')
            HEAD_REF=$(echo "$PR" | jq -r '.headRefName')
            UPDATED=$(echo "$PR" | jq -r '.updatedAt')

            # Check if Test workflow failed
            TEST_STATUS=$(echo "$PR" | jq -r '.statusCheckRollup[]? | select(.name == "Test") | .conclusion' || echo "")

            if [ "$TEST_STATUS" != "FAILURE" ]; then
              # Not a test failure, skip
              continue
            fi

            echo ""
            echo "‚ùå PR #$PR_NUMBER has failed tests: $TITLE"
            FAILED_COUNT=$((FAILED_COUNT + 1))

            # Extract issue number from branch name
            ISSUE_NUMBER=$(echo "$HEAD_REF" | grep -oE 'issue-[0-9]+' | cut -d- -f2 || echo "")

            if [ -z "$ISSUE_NUMBER" ]; then
              echo "   ‚ö†Ô∏è  Could not extract issue number from branch: $HEAD_REF"
              continue
            fi

            echo "   üìù Related issue: #$ISSUE_NUMBER"

            # Check for existing code retry labels
            CURRENT_RETRY=0
            CODE_RETRY_LABELS=$(echo "$PR" | jq -r '.labels[]?.name | select(startswith("code-retry:"))' || echo "")

            if [ -n "$CODE_RETRY_LABELS" ]; then
              # Extract highest retry number
              for label in $CODE_RETRY_LABELS; do
                NUM=$(echo "$label" | cut -d: -f2)
                if [ "$NUM" -gt "$CURRENT_RETRY" ]; then
                  CURRENT_RETRY=$NUM
                fi
              done
            fi

            echo "   üìä Current code retry count: $CURRENT_RETRY"

            # Check if max retries reached
            if [ "$CURRENT_RETRY" -ge "$MAX_CODE_RETRIES" ]; then
              echo "   ‚ùå Max retries reached ($MAX_CODE_RETRIES), marking as failed"

              # Mark issue as failed
              gh issue edit "$ISSUE_NUMBER" \
                --repo sovrium/sovrium \
                --remove-label "tdd-spec:in-progress" \
                --add-label "tdd-spec:failed" \
                --add-label "max-retries-exhausted" || true

              # Add comment explaining failure
              gh issue comment "$ISSUE_NUMBER" \
                --repo sovrium/sovrium \
                --body "‚ùå **Automatic Retries Exhausted**

Test failures persisted after $MAX_CODE_RETRIES automatic retry attempts.

**PR**: #$PR_NUMBER
**Final Status**: Tests continue to fail
**Action Required**: Manual intervention needed

The spec has been marked as \`tdd-spec:failed\`. The queue processor will continue with the next spec.

---
*ü§ñ Automated Test Failure Handler*" || true

              continue
            fi

            # Check when last updated to avoid retrying too quickly
            NOW=$(date +%s)
            UPDATED_EPOCH=$(date -d "$UPDATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$UPDATED" +%s 2>/dev/null || echo "$NOW")
            AGE_MINUTES=$(( (NOW - UPDATED_EPOCH) / 60 ))

            echo "   ‚è±Ô∏è  Test failed ${AGE_MINUTES} minutes ago"

            # Skip if failure is very recent (< 5 minutes) to allow CI to complete
            if [ "$AGE_MINUTES" -lt 5 ]; then
              echo "   ‚è≥ Test failure too recent, waiting for CI to settle"
              continue
            fi

            # Check for recent retry comments (within last 30 minutes)
            RECENT_RETRY=$(gh issue view "$ISSUE_NUMBER" \
              --repo sovrium/sovrium \
              --comments \
              --json comments \
              --jq '[.comments[] | select(.createdAt > (now - 1800 | todate) and .body | contains("@claude retry"))] | length' || echo "0")

            if [ "$RECENT_RETRY" -gt 0 ]; then
              echo "   ‚è≥ Recent retry already in progress (within last 30 minutes), skipping"
              continue
            fi

            # Trigger retry
            NEXT_RETRY=$((CURRENT_RETRY + 1))
            echo "   üîÑ Triggering automatic retry (attempt $NEXT_RETRY of $MAX_CODE_RETRIES)..."

            # Add retry label to PR
            gh pr edit "$PR_NUMBER" \
              --repo sovrium/sovrium \
              --add-label "code-retry:$NEXT_RETRY" || true

            # Add retry label to issue
            gh issue edit "$ISSUE_NUMBER" \
              --repo sovrium/sovrium \
              --add-label "code-retry:$NEXT_RETRY" || true

            # Post retry comment on issue (more reliable than PR)
            gh issue comment "$ISSUE_NUMBER" \
              --repo sovrium/sovrium \
              --body "üîÑ **Automatic Test Retry**

**Reason**: Test workflow failed on PR #$PR_NUMBER
**Retry Attempt**: $NEXT_RETRY of $MAX_CODE_RETRIES
**Failed after**: ${AGE_MINUTES} minutes

@claude retry implementation - Please fix the failing tests and ensure all checks pass.

**Debugging tips:**
- Check the test logs in PR #$PR_NUMBER
- Review recent changes that might have broken tests
- Ensure all dependencies are properly installed
- Verify environment-specific configurations

---
*ü§ñ Automated Test Failure Handler*" || true

            echo "   ‚úÖ Retry triggered for issue #$ISSUE_NUMBER"
            RETRY_TRIGGERED_COUNT=$((RETRY_TRIGGERED_COUNT + 1))
          done

          echo ""
          echo "üìä Test Failure Summary:"
          echo "   Failed PRs found: $FAILED_COUNT"
          echo "   Retries triggered: $RETRY_TRIGGERED_COUNT"
          echo "‚úÖ Test failure monitoring complete"
