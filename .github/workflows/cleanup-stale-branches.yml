name: Cleanup Stale TDD Branches

# Purpose: Periodic cleanup of stale branches from closed/merged PRs
# This is a safety net that complements:
# - GitHub's auto-delete setting (handles merged PRs)
# - delete-tdd-branch job in test.yml (handles closed PRs)

on:
  schedule:
    - cron: '0 2 * * 0' # Weekly on Sundays at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  cleanup:
    name: Cleanup Stale Branches
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cleanup stale branches
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Scanning for stale TDD branches..."

          # Get all tdd/ and claude/ branches
          ALL_TDD_BRANCHES=$(git ls-remote --heads origin | awk '{print $2}' | sed 's|refs/heads/||' | grep -E '^(tdd|claude)/' || true)

          if [ -z "$ALL_TDD_BRANCHES" ]; then
            echo "‚úÖ No TDD branches found - nothing to clean up"
            exit 0
          fi

          echo "Found $(echo "$ALL_TDD_BRANCHES" | wc -l) TDD branches"

          # Check each branch against PRs
          DELETED_COUNT=0
          KEPT_COUNT=0

          while IFS= read -r branch; do
            # Check if there's an open PR for this branch
            OPEN_PR=$(gh pr list --head "$branch" --state open --json number --jq '.[0].number' || echo "")

            if [ -n "$OPEN_PR" ]; then
              echo "‚è≠Ô∏è  Keeping branch (open PR #$OPEN_PR): $branch"
              KEPT_COUNT=$((KEPT_COUNT + 1))
              continue
            fi

            # Check if there's a closed/merged PR for this branch
            CLOSED_PR=$(gh pr list --head "$branch" --state closed --json number --jq '.[0].number' || echo "")
            MERGED_PR=$(gh pr list --head "$branch" --state merged --json number --jq '.[0].number' || echo "")

            if [ -n "$CLOSED_PR" ] || [ -n "$MERGED_PR" ]; then
              echo "üóëÔ∏è  Deleting stale branch: $branch (PR closed/merged)"
              if gh api --method DELETE "/repos/${{ github.repository }}/git/refs/heads/$branch" 2>/dev/null; then
                DELETED_COUNT=$((DELETED_COUNT + 1))
              else
                echo "‚ö†Ô∏è  Failed to delete $branch (may already be deleted)"
              fi
            else
              # No PR found - this might be an orphaned branch or work in progress
              # Check branch age (only delete if older than 7 days)
              BRANCH_AGE_DAYS=$(( ($(date +%s) - $(git log -1 --format=%ct origin/$branch 2>/dev/null || echo 0)) / 86400 ))

              if [ "$BRANCH_AGE_DAYS" -gt 7 ]; then
                echo "üóëÔ∏è  Deleting orphaned branch (>7 days old, no PR): $branch"
                if gh api --method DELETE "/repos/${{ github.repository }}/git/refs/heads/$branch" 2>/dev/null; then
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                else
                  echo "‚ö†Ô∏è  Failed to delete $branch"
                fi
              else
                echo "‚è≠Ô∏è  Keeping recent branch (no PR yet): $branch"
                KEPT_COUNT=$((KEPT_COUNT + 1))
              fi
            fi
          done <<< "$ALL_TDD_BRANCHES"

          echo ""
          echo "üìä Cleanup Summary:"
          echo "  - Deleted: $DELETED_COUNT branches"
          echo "  - Kept: $KEPT_COUNT branches"
          echo "‚úÖ Cleanup complete"
