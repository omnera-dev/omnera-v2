name: Claude Code TDD

# Trigger Strategy:
# - workflow_dispatch: Manual trigger with specific issue number (for debugging/retry)
# - issue_comment/PR review: Triggered by @claude mentions
#   - Automated: Queue processor posts @claude comment (primary automation path)
#   - Manual: Human posts @claude for interactive use

on:
  # Manual trigger: Process specific issue number
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

  # Manual triggers: @claude mentions in issues/PRs (interactive use)
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

# Concurrency control: Prevent duplicate runs
# - workflow_dispatch: Use global TDD queue lock (strict serial processing)
# - issue_comment: Check if comment is from queue automation (ðŸ¤– in title)
#   - If automated: Use same 'tdd-automation' group (serial queue processing)
#   - If manual: Use per-issue concurrency (allows manual @claude without conflicts)
concurrency:
  group: claude-${{
    github.event_name == 'workflow_dispatch' && 'tdd-automation' ||
    (github.event_name == 'issue_comment' && contains(github.event.issue.title, 'ðŸ¤–')) && 'tdd-automation' ||
    (github.event_name == 'issues' && contains(github.event.issue.title, 'ðŸ¤–')) && 'tdd-automation' ||
    github.event.issue.number ||
    github.event.pull_request.number ||
    'default'
    }}
  cancel-in-progress: true

jobs:
  # Pre-check job: Validate context exists before running Claude Code
  # Prevents wasted resources when there's no spec to process
  validate-context:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      issues: read
    outputs:
      has_context: ${{ steps.check.outputs.has_context }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      issue_body: ${{ steps.check.outputs.issue_body }}
    steps:
      - name: Check for valid context
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          # Security: Use env vars for untrusted user input to prevent code injection
          EVENT_COMMENT_BODY: ${{ github.event.comment.body }}
          EVENT_ISSUE_BODY: ${{ github.event.issue.body }}
          EVENT_ISSUE_TITLE: ${{ github.event.issue.title }}
          EVENT_REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          HAS_CONTEXT="false"
          ISSUE_NUMBER=""
          ISSUE_BODY=""

          # workflow_dispatch: Must have valid issue number
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
            if [ -n "$ISSUE_NUMBER" ]; then
              echo "ðŸ” Validating issue #$ISSUE_NUMBER (workflow_dispatch trigger)..."
              if gh issue view "$ISSUE_NUMBER" &>/dev/null; then
                ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')
                HAS_CONTEXT="true"
                echo "âœ… Valid issue found: #$ISSUE_NUMBER"
              else
                echo "âŒ Issue #$ISSUE_NUMBER not found - skipping workflow"
              fi
            else
              echo "âŒ No issue number provided - skipping workflow"
            fi

          # issue_comment/PR review: Must have @claude mention and valid issue/PR
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            if [[ "$EVENT_COMMENT_BODY" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              ISSUE_BODY="$EVENT_ISSUE_BODY"
              HAS_CONTEXT="true"
              echo "âœ… Valid @claude mention in issue #$ISSUE_NUMBER"
            else
              echo "âš ï¸  No @claude mention found - skipping workflow"
            fi

          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            if [[ "$EVENT_COMMENT_BODY" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.pull_request.number }}"
              HAS_CONTEXT="true"
              echo "âœ… Valid @claude mention in PR #$ISSUE_NUMBER"
            else
              echo "âš ï¸  No @claude mention found - skipping workflow"
            fi

          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            if [[ "$EVENT_REVIEW_BODY" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.pull_request.number }}"
              HAS_CONTEXT="true"
              echo "âœ… Valid @claude mention in PR review #$ISSUE_NUMBER"
            else
              echo "âš ï¸  No @claude mention found - skipping workflow"
            fi

          elif [ "${{ github.event_name }}" = "issues" ]; then
            if [[ "$EVENT_ISSUE_BODY" == *"@claude"* ]] || [[ "$EVENT_ISSUE_TITLE" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              ISSUE_BODY="$EVENT_ISSUE_BODY"
              HAS_CONTEXT="true"
              echo "âœ… Valid @claude mention in issue #$ISSUE_NUMBER"
            else
              echo "âš ï¸  No @claude mention found - skipping workflow"
            fi
          fi

          # Output results
          echo "has_context=$HAS_CONTEXT" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  claude:
    needs: validate-context
    # Only run if context validation passed
    if: |
      needs.validate-context.outputs.has_context == 'true' && (
        github.event_name == 'workflow_dispatch' ||
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR' ||
        github.event.issue.author_association == 'OWNER' ||
        github.event.issue.author_association == 'MEMBER' ||
        github.event.issue.author_association == 'COLLABORATOR' ||
        github.event.review.author_association == 'OWNER' ||
        github.event.review.author_association == 'MEMBER' ||
        github.event.review.author_association == 'COLLABORATOR' ||
        github.event.sender.login == 'github-actions[bot]' ||
        github.event.sender.login == 'github-actions' ||
        github.event.sender.login == 'app/github-actions' ||
        github.event.issue.user.login == 'github-actions[bot]' ||
        github.event.issue.user.login == 'github-actions' ||
        github.event.issue.user.login == 'app/github-actions' ||
        github.event.comment.user.login == 'github-actions[bot]' ||
        github.event.comment.user.login == 'github-actions' ||
        github.event.comment.user.login == 'app/github-actions'
      ) && (
        github.event.sender.login != 'claude[bot]'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Claude Code implementation + refactoring + retry can take time
    permissions:
      contents: write # Need write to push to TDD branches
      pull-requests: write # Need write to create PRs
      issues: write # Need write to update issue labels
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history to checkout branches

      - name: Extract and checkout TDD branch if specified
        id: branch
        env:
          # Security: Only use validated outputs from validate-context job
          # Never directly reference untrusted github.event data here
          ISSUE_BODY: ${{ needs.validate-context.outputs.issue_body }}
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Output issue number for later steps
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Extract TDD branch from issue body using env vars to avoid bash expansion
          # Look for tdd/spec-* pattern in validated issue body
          BRANCH=$(echo "$ISSUE_BODY" | grep -o 'tdd/spec-[A-Z-]*[0-9]*' | head -1 || true)

          if [ -n "$BRANCH" ]; then
            echo "Found TDD branch: $BRANCH"

            # Check if branch exists remotely
            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              echo "âœ… Branch $BRANCH exists, checking out..."
              git fetch origin "$BRANCH"
              git checkout "$BRANCH"
              echo "tdd_branch=$BRANCH" >> $GITHUB_OUTPUT
              echo "using_tdd_branch=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Branch $BRANCH does not exist remotely, staying on main"
              echo "using_tdd_branch=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No TDD branch found in issue, staying on main"
            echo "using_tdd_branch=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # For workflow_dispatch: Provide explicit prompt to trigger action
          # For comment-triggered events: Omit prompt so action extracts from @claude comment
          prompt: >-
            ${{ github.event_name == 'workflow_dispatch' &&
            format('Implement TDD spec with 7-step workflow: 1) Run @agent-e2e-test-fixer to fix the test 2) Run @agent-codebase-refactor-auditor to refactor code (ALWAYS) 3) Commit changes (bun run license first) 4) Create PR to main with tdd-automation label and include "Closes #{0}" in PR body 5) Monitor test.yml validation - if fails, analyze errors, fix, push, retry (max 3 attempts with retry:N labels) - if 3 failures, mark issue tdd-spec:failed and exit 6) BEFORE enabling auto-merge, check for conflicts: fetch latest main and attempt rebase - if conflicts exist, resolve intelligently by merging both changes (e.g. add both props, combine logic), then re-run validation - use git push --force-with-lease after rebase 7) After validation passes, enable PR auto-merge with --squash 8) DO NOT close issue manually (closes automatically on PR merge). Branch already exists and is checked out.', steps.branch.outputs.issue_number) || '' }}

          # Multi-agent workflow: e2e-test-fixer for implementation, codebase-refactor-auditor for quality
          # Both agents run sequentially on every spec (ALWAYS)
          # - e2e-test-fixer: Test-first implementation with minimal code
          # - codebase-refactor-auditor: Code quality review and refactoring
          # Retry logic: Monitor test.yml, fix errors up to 3 times, mark as failed if still failing
          # --dangerously-skip-permissions: Bypass permission checks (required for GitHub Actions automation)
          claude_args: '--agents e2e-test-fixer codebase-refactor-auditor --dangerously-skip-permissions'
