name: Claude Code TDD

# Trigger Strategy:
# - workflow_dispatch: Manual trigger with specific issue number (for debugging/retry)
# - issue_comment/PR review: Triggered by @claude mentions
#   - Automated: Queue processor posts @claude comment (primary automation path)
#   - Manual: Human posts @claude for interactive use

on:
  # Manual trigger: Process specific issue number
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

  # Manual triggers: @claude mentions in issues/PRs (interactive use)
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

# Concurrency control: Prevent duplicate runs
# - workflow_dispatch: Use global TDD queue lock (strict serial processing)
# - issue_comment: Check if comment is from queue automation (ü§ñ in title)
#   - If automated: Use same 'tdd-automation' group (serial queue processing)
#   - If manual: Use per-issue concurrency (allows manual @claude without conflicts)
concurrency:
  group: claude-${{
    github.event_name == 'workflow_dispatch' && 'tdd-automation' ||
    (github.event_name == 'issue_comment' && github.event.comment.user.login == 'claude[bot]') && format('skip-bot-{0}', github.run_id) ||
    (github.event_name == 'issue_comment' && contains(github.event.issue.title, 'ü§ñ')) && 'tdd-automation' ||
    (github.event_name == 'issues' && contains(github.event.issue.title, 'ü§ñ')) && 'tdd-automation' ||
    github.event.issue.number ||
    github.event.pull_request.number ||
    'default'
    }}
  cancel-in-progress: true

jobs:
  # Pre-check job: Validate context exists before running Claude Code
  # Prevents wasted resources when there's no spec to process
  validate-context:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      issues: read
    outputs:
      has_context: ${{ steps.check.outputs.has_context }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      issue_body: ${{ steps.check.outputs.issue_body }}
    steps:
      - name: Check for valid context
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          # Security: Use env vars for untrusted user input to prevent code injection
          EVENT_COMMENT_BODY: ${{ github.event.comment.body }}
          EVENT_ISSUE_BODY: ${{ github.event.issue.body }}
          EVENT_ISSUE_TITLE: ${{ github.event.issue.title }}
          EVENT_REVIEW_BODY: ${{ github.event.review.body }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
        run: |
          HAS_CONTEXT="false"
          ISSUE_NUMBER=""
          ISSUE_BODY=""

          # Skip if comment is from Claude bot (prevents race condition with error comments)
          # Also skip "Claude Code is working" status comments (prevents self-cancellation)
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            if [ "$COMMENT_USER" = "claude[bot]" ]; then
              echo "‚ö†Ô∏è  Comment from Claude bot - skipping to prevent cancellation race"
              echo "has_context=false" >> $GITHUB_OUTPUT
              echo "issue_number=" >> $GITHUB_OUTPUT
              echo "issue_body<<EOF" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              exit 0
            elif [[ "$EVENT_COMMENT_BODY" == *"Claude Code is working"* ]]; then
              echo "‚ö†Ô∏è  Claude Code status comment - skipping to prevent self-cancellation"
              echo "has_context=false" >> $GITHUB_OUTPUT
              echo "issue_number=" >> $GITHUB_OUTPUT
              echo "issue_body<<EOF" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # workflow_dispatch: Must have valid issue number
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
            if [ -n "$ISSUE_NUMBER" ]; then
              echo "üîç Validating issue #$ISSUE_NUMBER (workflow_dispatch trigger)..."
              if gh issue view "$ISSUE_NUMBER" &>/dev/null; then
                ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')
                HAS_CONTEXT="true"
                echo "‚úÖ Valid issue found: #$ISSUE_NUMBER"
              else
                echo "‚ùå Issue #$ISSUE_NUMBER not found - skipping workflow"
              fi
            else
              echo "‚ùå No issue number provided - skipping workflow"
            fi

          # issue_comment/PR review: Must have @claude mention and valid issue/PR
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            if [[ "$EVENT_COMMENT_BODY" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              ISSUE_BODY="$EVENT_ISSUE_BODY"
              HAS_CONTEXT="true"
              echo "‚úÖ Valid @claude mention in issue #$ISSUE_NUMBER"
            else
              echo "‚ö†Ô∏è  No @claude mention found - skipping workflow"
            fi

          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            if [[ "$EVENT_COMMENT_BODY" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.pull_request.number }}"
              HAS_CONTEXT="true"
              echo "‚úÖ Valid @claude mention in PR #$ISSUE_NUMBER"
            else
              echo "‚ö†Ô∏è  No @claude mention found - skipping workflow"
            fi

          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            if [[ "$EVENT_REVIEW_BODY" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.pull_request.number }}"
              HAS_CONTEXT="true"
              echo "‚úÖ Valid @claude mention in PR review #$ISSUE_NUMBER"
            else
              echo "‚ö†Ô∏è  No @claude mention found - skipping workflow"
            fi

          elif [ "${{ github.event_name }}" = "issues" ]; then
            if [[ "$EVENT_ISSUE_BODY" == *"@claude"* ]] || [[ "$EVENT_ISSUE_TITLE" == *"@claude"* ]]; then
              ISSUE_NUMBER="${{ github.event.issue.number }}"
              ISSUE_BODY="$EVENT_ISSUE_BODY"
              HAS_CONTEXT="true"
              echo "‚úÖ Valid @claude mention in issue #$ISSUE_NUMBER"
            else
              echo "‚ö†Ô∏è  No @claude mention found - skipping workflow"
            fi
          fi

          # Output results
          echo "has_context=$HAS_CONTEXT" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  claude:
    needs: validate-context
    # Only run if context validation passed
    if: |
      needs.validate-context.outputs.has_context == 'true' && (
        github.event_name == 'workflow_dispatch' ||
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR' ||
        github.event.issue.author_association == 'OWNER' ||
        github.event.issue.author_association == 'MEMBER' ||
        github.event.issue.author_association == 'COLLABORATOR' ||
        github.event.review.author_association == 'OWNER' ||
        github.event.review.author_association == 'MEMBER' ||
        github.event.review.author_association == 'COLLABORATOR' ||
        github.event.sender.login == 'github-actions[bot]' ||
        github.event.sender.login == 'github-actions' ||
        github.event.sender.login == 'app/github-actions' ||
        github.event.issue.user.login == 'github-actions[bot]' ||
        github.event.issue.user.login == 'github-actions' ||
        github.event.issue.user.login == 'app/github-actions' ||
        github.event.comment.user.login == 'github-actions[bot]' ||
        github.event.comment.user.login == 'github-actions' ||
        github.event.comment.user.login == 'app/github-actions'
      ) && (
        github.event.sender.login != 'claude[bot]'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Claude Code implementation + refactoring + retry can take time
    permissions:
      contents: write # Need write to push to TDD branches
      pull-requests: write # Need write to create PRs
      issues: write # Need write to update issue labels
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for Claude Code action

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # For workflow_dispatch: Provide explicit prompt to trigger action
          # For comment-triggered events: Omit prompt so action extracts from @claude comment
          prompt: >-
            ${{ github.event_name == 'workflow_dispatch' &&
            format('Implement TDD spec with 7-step workflow: 1) Run @agent-e2e-test-fixer to fix the test 2) Run @agent-codebase-refactor-auditor to refactor code (ALWAYS) 3) Commit changes (bun run license first) 4) ALWAYS create PR to main with tdd-automation label and include "Closes #{0}" in PR body - REQUIRED even if only .fixme() removal, NO EXCEPTIONS 5) Monitor test.yml validation - if fails, analyze errors, fix, push, retry (max 3 attempts with retry:N labels) - if 3 failures, mark issue tdd-spec:failed and exit 6) BEFORE enabling auto-merge, check for conflicts: fetch latest main and attempt rebase - if conflicts exist, resolve intelligently by merging both changes (e.g. add both props, combine logic), then re-run validation - use git push --force-with-lease after rebase 7) After validation passes, enable PR auto-merge with --squash 8) DO NOT close issue manually (closes automatically on PR merge).', needs.validate-context.outputs.issue_number) || '' }}

          # Multi-agent workflow: e2e-test-fixer for implementation, codebase-refactor-auditor for quality
          # Both agents run sequentially on every spec (ALWAYS)
          # - e2e-test-fixer: Test-first implementation with minimal code
          # - codebase-refactor-auditor: Code quality review and refactoring
          # Retry logic: Monitor test.yml, fix errors up to 3 times, mark as failed if still failing
          # --dangerously-skip-permissions: Bypass permission checks (required for GitHub Actions automation)
          claude_args: '--agents e2e-test-fixer codebase-refactor-auditor --dangerously-skip-permissions'

      - name: Verify PR was created
        id: verify_pr
        if: steps.claude.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
        run: |
          echo "üîç Verifying PR was created for issue #$ISSUE_NUMBER..."

          # Wait up to 2 minutes for PR to appear (Claude may need time to push and create PR)
          PR_FOUND=false
          for i in {1..12}; do
            # Search for PRs from branches matching claude/issue-* pattern (created automatically by Claude Code)
            PR_COUNT=$(gh pr list --json number,headRefName --jq "[.[] | select(.headRefName | test(\"^claude/issue-.*$ISSUE_NUMBER.*\"))] | length")

            if [ "$PR_COUNT" -gt 0 ]; then
              PR_NUMBER=$(gh pr list --json number,headRefName --jq "[.[] | select(.headRefName | test(\"^claude/issue-.*$ISSUE_NUMBER.*\"))][0].number")
              echo "‚úÖ PR #$PR_NUMBER found!"
              echo "pr_created=true" >> $GITHUB_OUTPUT
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
              PR_FOUND=true
              break
            fi

            echo "Attempt $i/12: PR not found yet, waiting 10 seconds..."
            sleep 10
          done

          if [ "$PR_FOUND" = false ]; then
            echo "‚ùå No PR found after 2 minutes - marking issue as failed"
            echo "pr_created=false" >> $GITHUB_OUTPUT

            # Mark issue as failed (same as retry exhaustion)
            gh issue edit "$ISSUE_NUMBER" \
              --remove-label "tdd-spec:in-progress" \
              --add-label "tdd-spec:failed"

            gh issue comment "$ISSUE_NUMBER" \
              --body "‚ùå **TDD Automation Failed: PR Not Created**

            Claude Code finished successfully but did not create a pull request. This is required for the TDD automation workflow to complete.

            **Next Steps**:
            1. Review Claude Code's work in the branch (if created)
            2. Manually create PR if changes exist
            3. Or re-run this spec if needed

            **Issue Status**: Marked as \`tdd-spec:failed\` - requires manual intervention.
            **Pipeline Status**: Queue processor will continue with next spec (this issue does not block the pipeline).

            ---
            *ü§ñ Automated via [TDD Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

            exit 1
          fi
