name: Claude Code TDD

# Trigger Strategy:
# - workflow_run: Automatically triggers when TDD Queue Processor completes
# - workflow_dispatch: Manual trigger with specific issue number (for debugging/retry)
# - issue_comment/PR review: Manual @claude mentions for interactive use
# - Uses label query to find the in-progress spec (workflow_run only)
# - Fully automatic TDD automation with zero API calls for triggering

on:
  # Automatic trigger: When queue processor completes, find in-progress spec
  workflow_run:
    workflows: ['TDD Queue - Processor']
    types: [completed]
    branches: [main]

  # Manual trigger: Process specific issue number
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

  # Manual triggers: @claude mentions in issues/PRs (interactive use)
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

# Concurrency control: Prevent duplicate runs for the same issue/PR + sender
# Each issue/PR + sender gets its own concurrency group to prevent:
# - User-triggered workflows from being canceled by bot-triggered workflows
# - Multiple bot comments from canceling each other
# This allows queue system to process multiple specs in parallel without interference
concurrency:
  group: claude-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}-${{ github.event.sender.login || github.event.sender.type || 'unknown' }}
  cancel-in-progress: true

jobs:
  claude:
    # Security: Only allow trusted users, automatic workflow_run trigger, and workflow_dispatch
    # Exclude claude[bot] to prevent self-triggering and cancellation loops
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
        (github.event_name == 'workflow_run') ||
        (github.event_name == 'workflow_dispatch')
      ) && (
        github.event_name == 'workflow_run' ||
        github.event_name == 'workflow_dispatch' ||
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR' ||
        github.event.issue.author_association == 'OWNER' ||
        github.event.issue.author_association == 'MEMBER' ||
        github.event.issue.author_association == 'COLLABORATOR' ||
        github.event.review.author_association == 'OWNER' ||
        github.event.review.author_association == 'MEMBER' ||
        github.event.review.author_association == 'COLLABORATOR' ||
        github.event.sender.login == 'github-actions[bot]' ||
        github.event.sender.login == 'github-actions' ||
        github.event.sender.login == 'app/github-actions' ||
        github.event.issue.user.login == 'github-actions[bot]' ||
        github.event.issue.user.login == 'github-actions' ||
        github.event.issue.user.login == 'app/github-actions' ||
        github.event.comment.user.login == 'github-actions[bot]' ||
        github.event.comment.user.login == 'github-actions' ||
        github.event.comment.user.login == 'app/github-actions'
      ) && (
        github.event.sender.login != 'claude[bot]'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Claude Code implementation + refactoring + retry can take time
    permissions:
      contents: write # Need write to push to TDD branches
      pull-requests: write # Need write to create PRs
      issues: write # Need write to update issue labels
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history to checkout branches

      - name: Query for in-progress spec (workflow_run trigger)
        id: query_spec
        if: github.event_name == 'workflow_run'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” Querying for in-progress spec..."

          # Find the single in-progress spec (strict serial processing)
          ISSUE_JSON=$(gh issue list --label "tdd-spec:in-progress" --json number,body --limit 1 --jq '.[0]')

          if [ -z "$ISSUE_JSON" ] || [ "$ISSUE_JSON" = "null" ]; then
            echo "âš ï¸  No in-progress spec found - queue processor may have completed without processing"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          ISSUE_NUMBER=$(echo "$ISSUE_JSON" | jq -r '.number')
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r '.body')

          echo "âœ… Found in-progress spec: #$ISSUE_NUMBER"
          echo "found=true" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract and checkout TDD branch if specified
        id: branch
        if: github.event_name == 'issue_comment' || github.event_name == 'issues' || github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch'
        env:
          ISSUE_BODY: ${{ github.event_name == 'workflow_run' && steps.query_spec.outputs.issue_body || github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event_name == 'workflow_run' && steps.query_spec.outputs.issue_number || github.event.inputs.issue_number || github.event.issue.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Skip if workflow_run didn't find a spec
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ steps.query_spec.outputs.found }}" != "true" ]; then
            echo "Skipping: no in-progress spec found"
            exit 0
          fi

          # For workflow_dispatch, fetch issue body via gh CLI
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')
            COMMENT_BODY=""
          fi

          # Extract TDD branch from issue body or comment using env vars to avoid bash expansion
          # Look for tdd/spec-* pattern in issue body first, then comment
          BRANCH=$(echo "$ISSUE_BODY" | grep -o 'tdd/spec-[A-Z-]*[0-9]*' | head -1 || true)

          if [ -z "$BRANCH" ]; then
            BRANCH=$(echo "$COMMENT_BODY" | grep -o 'tdd/spec-[A-Z-]*[0-9]*' | head -1 || true)
          fi

          if [ -n "$BRANCH" ]; then
            echo "Found TDD branch: $BRANCH"

            # Check if branch exists remotely
            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              echo "âœ… Branch $BRANCH exists, checking out..."
              git fetch origin "$BRANCH"
              git checkout "$BRANCH"
              echo "tdd_branch=$BRANCH" >> $GITHUB_OUTPUT
              echo "using_tdd_branch=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Branch $BRANCH does not exist remotely, staying on main"
              echo "using_tdd_branch=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No TDD branch found in issue, staying on main"
            echo "using_tdd_branch=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # For workflow_run/workflow_dispatch: Provide explicit prompt to trigger action
          # For comment-triggered events: Omit prompt so action extracts from @claude comment
          prompt: >-
            ${{ (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch') &&
            'Implement TDD spec with 6-step workflow: 1) Run @agent-e2e-test-fixer to fix the test 2) Run @agent-codebase-refactor-auditor to refactor code (ALWAYS) 3) Commit changes (bun run license first) 4) Create PR to main with tdd-automation label 5) Monitor test.yml validation - if fails, analyze errors, fix, push, retry (max 3 attempts with retry:N labels) - if 3 failures, mark issue tdd-spec:failed and exit - if passes, enable PR auto-merge with --squash 6) DO NOT close issue (closes on PR merge). Branch already exists and is checked out.' || '' }}

          # Multi-agent workflow: e2e-test-fixer for implementation, codebase-refactor-auditor for quality
          # Both agents run sequentially on every spec (ALWAYS)
          # - e2e-test-fixer: Test-first implementation with minimal code
          # - codebase-refactor-auditor: Code quality review and refactoring
          # Retry logic: Monitor test.yml, fix errors up to 3 times, mark as failed if still failing
          # --dangerously-skip-permissions: Bypass permission checks (required for GitHub Actions automation)
          claude_args: '--agents e2e-test-fixer codebase-refactor-auditor --dangerously-skip-permissions'
