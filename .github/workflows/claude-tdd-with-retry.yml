name: Claude Code TDD (With Retry)

# This workflow wraps the main Claude Code execution with infrastructure-level retry logic
# It handles Claude Code runtime errors (EPERM, timeouts, crashes) separately from code errors

on:
  # Manual trigger: Process specific issue number
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      retry_attempt:
        description: 'Current retry attempt (1-3)'
        required: false
        type: number
        default: 1

  # Triggered by queue processor via repository_dispatch
  repository_dispatch:
    types: [tdd-spec-process]

# Concurrency control: Use TDD queue lock for serial processing
concurrency:
  group: tdd-automation
  cancel-in-progress: false

env:
  MAX_INFRASTRUCTURE_RETRIES: 3
  CLAUDE_TIMEOUT_MINUTES: 60

jobs:
  # Error classification: Determine if error is retriable at infrastructure level
  classify-previous-error:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.retry_attempt > 1
    permissions:
      actions: read
    outputs:
      is_infrastructure_error: ${{ steps.classify.outputs.is_infrastructure_error }}
      error_type: ${{ steps.classify.outputs.error_type }}
      should_retry: ${{ steps.classify.outputs.should_retry }}
    steps:
      - name: Classify previous run error
        id: classify
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        run: |
          echo "üîç Analyzing previous workflow run for error classification..."

          # Get the most recent failed run for this issue
          RECENT_RUN=$(gh run list \
            --workflow="claude-tdd.yml" \
            --status failure \
            --limit 5 \
            --json databaseId,conclusion,displayTitle \
            --jq ".[] | select(.displayTitle | contains(\"#$ISSUE_NUMBER\")) | .databaseId" \
            | head -1)

          if [ -z "$RECENT_RUN" ]; then
            echo "‚ö†Ô∏è  No recent failed run found - assuming infrastructure error"
            echo "is_infrastructure_error=true" >> $GITHUB_OUTPUT
            echo "error_type=unknown" >> $GITHUB_OUTPUT
            echo "should_retry=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üìã Analyzing run #$RECENT_RUN..."

          # Get failure logs
          LOGS=$(gh run view "$RECENT_RUN" --log-failed || echo "")

          # Classify error type
          IS_INFRA_ERROR=false
          ERROR_TYPE="unknown"

          # Infrastructure errors (retriable at workflow level)
          if echo "$LOGS" | grep -q "EPERM: Operation not permitted"; then
            IS_INFRA_ERROR=true
            ERROR_TYPE="permission_error"
            echo "üîß Detected: Permission error (EPERM)"
          elif echo "$LOGS" | grep -q "ETIMEDOUT\|timeout\|timed out"; then
            IS_INFRA_ERROR=true
            ERROR_TYPE="timeout"
            echo "‚è±Ô∏è  Detected: Timeout error"
          elif echo "$LOGS" | grep -q "ECONNRESET\|ENOTFOUND\|socket hang up"; then
            IS_INFRA_ERROR=true
            ERROR_TYPE="network_error"
            echo "üåê Detected: Network error"
          elif echo "$LOGS" | grep -q "out of memory\|OOM\|killed"; then
            IS_INFRA_ERROR=true
            ERROR_TYPE="resource_exhaustion"
            echo "üíæ Detected: Resource exhaustion"
          elif echo "$LOGS" | grep -q "ENOSPC\|no space left"; then
            IS_INFRA_ERROR=true
            ERROR_TYPE="disk_full"
            echo "üíΩ Detected: Disk space error"
          elif echo "$LOGS" | grep -q "cancelled\|canceled"; then
            IS_INFRA_ERROR=true
            ERROR_TYPE="workflow_cancelled"
            echo "üö´ Detected: Workflow cancellation"
          # Code/test errors (NOT retriable at infrastructure level)
          elif echo "$LOGS" | grep -q "Test.*failed\|FAIL\|AssertionError"; then
            ERROR_TYPE="test_failure"
            echo "‚ùå Detected: Test failure (code error)"
          elif echo "$LOGS" | grep -q "SyntaxError\|TypeError\|ReferenceError"; then
            ERROR_TYPE="code_error"
            echo "‚ùå Detected: Code error"
          elif echo "$LOGS" | grep -q "lint.*error\|ESLint.*error"; then
            ERROR_TYPE="lint_error"
            echo "‚ùå Detected: Lint error"
          fi

          # Determine if should retry
          SHOULD_RETRY=false
          if [ "$IS_INFRA_ERROR" = true ]; then
            SHOULD_RETRY=true
            echo "‚úÖ Infrastructure error detected - WILL RETRY"
          else
            echo "‚ö†Ô∏è  Code/test error detected - will NOT retry at infrastructure level"
          fi

          # Output results
          echo "is_infrastructure_error=$IS_INFRA_ERROR" >> $GITHUB_OUTPUT
          echo "error_type=$ERROR_TYPE" >> $GITHUB_OUTPUT
          echo "should_retry=$SHOULD_RETRY" >> $GITHUB_OUTPUT

  # Main Claude Code execution with timeout monitoring
  execute-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 65 # Slightly longer than Claude timeout to allow cleanup
    needs: [classify-previous-error]
    if: |
      always() &&
      (needs.classify-previous-error.result == 'skipped' ||
       needs.classify-previous-error.outputs.should_retry == 'true')
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    outputs:
      claude_success: ${{ steps.claude.outcome == 'success' }}
      claude_exit_code: ${{ steps.claude.outcome }}
      error_type: ${{ steps.detect_error.outputs.error_type }}
      is_infrastructure_error: ${{ steps.detect_error.outputs.is_infrastructure_error }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number || github.event.client_payload.issue_number }}
        run: |
          echo "üìã Fetching issue #$ISSUE_NUMBER details..."
          ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 60
        continue-on-error: true # Capture exit code instead of failing immediately
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          prompt: >-
            Implement TDD spec with 7-step workflow:
            1) Run @agent-e2e-test-fixer to fix the test
            2) Run @agent-codebase-refactor-auditor to refactor code (ALWAYS)
            3) Commit changes (bun run license first)
            4) ALWAYS create PR to main with tdd-automation label and include "Closes #${{ steps.issue.outputs.issue_number }}" in PR body - REQUIRED even if only .fixme() removal, NO EXCEPTIONS
            5) Monitor test.yml validation - if fails, analyze errors, fix, push, retry (max 3 attempts with retry:N labels) - if 3 failures, mark issue tdd-spec:failed and exit
            6) BEFORE enabling auto-merge, check for conflicts: fetch latest main and attempt rebase - if conflicts exist, resolve intelligently by merging both changes (e.g. add both props, combine logic), then re-run validation - use git push --force-with-lease after rebase
            7) After validation passes, enable PR auto-merge with --squash
            8) DO NOT close issue manually (closes automatically on PR merge).
          claude_args: '--agents e2e-test-fixer codebase-refactor-auditor --dangerously-skip-permissions'

      - name: Detect error type
        id: detect_error
        if: steps.claude.outcome != 'success'
        run: |
          echo "üîç Analyzing Claude Code failure..."

          # Check Claude Code exit behavior
          CLAUDE_OUTCOME="${{ steps.claude.outcome }}"

          IS_INFRA_ERROR=false
          ERROR_TYPE="unknown"

          if [ "$CLAUDE_OUTCOME" = "cancelled" ]; then
            IS_INFRA_ERROR=true
            ERROR_TYPE="workflow_cancelled"
            echo "üö´ Claude Code was cancelled"
          elif [ "$CLAUDE_OUTCOME" = "failure" ]; then
            # For failures, we need to check logs in retry workflow
            ERROR_TYPE="claude_failure"
            echo "‚ùå Claude Code failed - will classify in retry logic"
            IS_INFRA_ERROR=true # Assume infrastructure until proven otherwise
          else
            ERROR_TYPE="unknown_outcome"
            echo "‚ùì Unknown outcome: $CLAUDE_OUTCOME"
            IS_INFRA_ERROR=true
          fi

          echo "is_infrastructure_error=$IS_INFRA_ERROR" >> $GITHUB_OUTPUT
          echo "error_type=$ERROR_TYPE" >> $GITHUB_OUTPUT

      - name: Update issue on failure
        if: steps.claude.outcome != 'success'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.issue_number }}
          RETRY_ATTEMPT: ${{ github.event.inputs.retry_attempt || 1 }}
          ERROR_TYPE: ${{ steps.detect_error.outputs.error_type }}
        run: |
          echo "üìù Updating issue #$ISSUE_NUMBER with failure information..."

          gh issue comment "$ISSUE_NUMBER" --body "‚ö†Ô∏è **Claude Code Execution Failed (Attempt $RETRY_ATTEMPT)**

          **Error Type**: \`$ERROR_TYPE\`
          **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          The automation system will analyze this error and retry if appropriate.

          ---
          *ü§ñ Infrastructure Error Handler*"

  # Retry logic: Automatically retry infrastructure errors
  handle-retry:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [execute-claude]
    if: |
      always() &&
      needs.execute-claude.outputs.claude_success != 'true' &&
      needs.execute-claude.outputs.is_infrastructure_error == 'true'
    permissions:
      actions: write
      issues: write
    steps:
      - name: Determine retry action
        id: retry
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number || github.event.client_payload.issue_number }}
          CURRENT_RETRY: ${{ github.event.inputs.retry_attempt || 1 }}
          MAX_RETRIES: ${{ env.MAX_INFRASTRUCTURE_RETRIES }}
          ERROR_TYPE: ${{ needs.execute-claude.outputs.error_type }}
        run: |
          echo "üîÑ Infrastructure error detected: $ERROR_TYPE"
          echo "üìä Current retry attempt: $CURRENT_RETRY of $MAX_RETRIES"

          NEXT_RETRY=$((CURRENT_RETRY + 1))

          if [ "$NEXT_RETRY" -le "$MAX_RETRIES" ]; then
            echo "‚úÖ Will retry (attempt $NEXT_RETRY)"
            echo "should_retry=true" >> $GITHUB_OUTPUT
            echo "next_retry=$NEXT_RETRY" >> $GITHUB_OUTPUT

            # Add retry label
            gh issue edit "$ISSUE_NUMBER" --add-label "infrastructure-retry:$CURRENT_RETRY"

            # Add comment
            gh issue comment "$ISSUE_NUMBER" --body "üîÑ **Automatic Infrastructure Retry**

            **Error Type**: \`$ERROR_TYPE\`
            **Retry Attempt**: $NEXT_RETRY of $MAX_RETRIES
            **Reason**: Infrastructure/environment error (not code-related)

            Retrying workflow automatically in 30 seconds...

            ---
            *ü§ñ Infrastructure Error Handler*"

            # Wait before retry to avoid race conditions
            sleep 30
          else
            echo "‚ùå Max retries exhausted ($MAX_RETRIES)"
            echo "should_retry=false" >> $GITHUB_OUTPUT

            # Mark as failed
            gh issue edit "$ISSUE_NUMBER" \
              --remove-label "tdd-spec:in-progress" \
              --add-label "tdd-spec:failed" \
              --add-label "infrastructure-error"

            gh issue comment "$ISSUE_NUMBER" --body "‚ùå **Infrastructure Error - Max Retries Exhausted**

            **Error Type**: \`$ERROR_TYPE\`
            **Total Attempts**: $MAX_RETRIES
            **Status**: Marked as \`tdd-spec:failed\`

            This spec failed due to infrastructure/environment errors, not code issues. Manual intervention required.

            **Possible Solutions**:
            1. Check GitHub Actions runner status
            2. Check if Claude Code API is experiencing issues
            3. Manually retry via workflow_dispatch
            4. Skip automation and implement manually

            The queue processor will continue with the next spec.

            ---
            *ü§ñ Infrastructure Error Handler*"
          fi

      - name: Trigger retry workflow
        if: steps.retry.outputs.should_retry == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number || github.event.client_payload.issue_number }}
          NEXT_RETRY: ${{ steps.retry.outputs.next_retry }}
        run: |
          echo "üöÄ Triggering retry workflow (attempt $NEXT_RETRY)..."

          gh workflow run claude-tdd-with-retry.yml \
            --field issue_number="$ISSUE_NUMBER" \
            --field retry_attempt="$NEXT_RETRY"

          echo "‚úÖ Retry workflow triggered successfully"

  # Success path: Verify PR was created (same as original workflow)
  verify-success:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [execute-claude]
    if: needs.execute-claude.outputs.claude_success == 'true'
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Verify PR was created
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number || github.event.client_payload.issue_number }}
        run: |
          echo "üîç Verifying PR was created for issue #$ISSUE_NUMBER..."

          # Wait up to 2 minutes for PR to appear
          PR_FOUND=false
          for i in {1..12}; do
            PR_COUNT=$(gh pr list --json number,headRefName --jq "[.[] | select(.headRefName | test(\"^claude/issue-.*$ISSUE_NUMBER.*\"))] | length")

            if [ "$PR_COUNT" -gt 0 ]; then
              PR_NUMBER=$(gh pr list --json number,headRefName --jq "[.[] | select(.headRefName | test(\"^claude/issue-.*$ISSUE_NUMBER.*\"))][0].number")
              echo "‚úÖ PR #$PR_NUMBER found!"
              PR_FOUND=true
              break
            fi

            echo "Attempt $i/12: PR not found yet, waiting 10 seconds..."
            sleep 10
          done

          if [ "$PR_FOUND" = false ]; then
            echo "‚ùå No PR found after 2 minutes - marking issue as failed"

            gh issue edit "$ISSUE_NUMBER" \
              --remove-label "tdd-spec:in-progress" \
              --add-label "tdd-spec:failed"

            gh issue comment "$ISSUE_NUMBER" \
              --body "‚ùå **TDD Automation Failed: PR Not Created**

            Claude Code finished successfully but did not create a pull request. This is required for the TDD automation workflow to complete.

            **Next Steps**:
            1. Review Claude Code's work in the branch (if created)
            2. Manually create PR if changes exist
            3. Or re-run this spec if needed

            **Issue Status**: Marked as \`tdd-spec:failed\` - requires manual intervention.
            **Pipeline Status**: Queue processor will continue with next spec (this issue does not block the pipeline).

            ---
            *ü§ñ Automated via [TDD Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

            exit 1
          fi
