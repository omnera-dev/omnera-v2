name: TDD Queue - Processor

on:
  # Scheduled runs - Every 15 minutes
  schedule:
    - cron: '*/15 * * * *'

  # Manual trigger
  workflow_dispatch:

# Security: Define minimal required permissions
# NOTE: Requires GH_PAT_WORKFLOW secret with 'repo' scope to post @claude mentions
# Comments posted with PAT appear from token owner's account (not github-actions bot)
# This triggers Claude Code workflow via issue_comment event
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

# Prevent concurrent processing (strict serial: one spec at a time)
# IMPORTANT: Shares concurrency group with tdd-daily-refactor.yml
# This ensures queue processor waits when daily refactor is running
concurrency:
  group: tdd-queue
  cancel-in-progress: false

env:
  BUN_VERSION: '1.3.1'

jobs:
  process-queue:
    name: üîÑ Process TDD Queue
    runs-on: ubuntu-latest
    timeout-minutes: 5 # Quick operation: fetch queue, update labels, post @claude comment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git operations

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Configure git with token user
        run: |
          USER_NAME=$(gh api user --jq '.login')
          USER_EMAIL=$(gh api user --jq '.email')
          git config user.name "$USER_NAME"
          git config user.email "$USER_EMAIL"
          echo "‚úÖ Git configured as $USER_NAME <$USER_EMAIL>"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}

      - name: Get next spec from queue
        id: next
        run: |
          echo "üîç Looking for next spec to process..."
          bun run scripts/tdd-automation/queue-manager.ts next
        env:
          GITHUB_OUTPUT: ${{ github.output }}
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW || github.token }}

      - name: Check if spec available
        id: check
        run: |
          if [ "${{ steps.next.outputs.has_next }}" != "true" ]; then
            echo "üì≠ No specs available to process"
            echo "should_process=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found spec to process: ${{ steps.next.outputs.spec_id }}"
            echo "should_process=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate issue state and check for duplicates
        if: steps.check.outputs.should_process == 'true'
        id: validate
        run: |
          ISSUE_NUMBER="${{ steps.next.outputs.issue_number }}"
          SPEC_ID="${{ steps.next.outputs.spec_id }}"

          echo "üîç Validating issue #$ISSUE_NUMBER before processing..."

          # Check if issue is still open
          ISSUE_STATE=$(gh issue view "$ISSUE_NUMBER" --json state --jq '.state')

          if [ "$ISSUE_STATE" = "CLOSED" ]; then
            echo "‚ö†Ô∏è  Issue #$ISSUE_NUMBER is already CLOSED"
            echo "   Skipping processing (likely already completed by another PR)"

            # Update the issue to remove in-progress label if present
            gh issue edit "$ISSUE_NUMBER" --remove-label "tdd-spec:in-progress" || true

            echo "should_process=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for existing open PRs for this issue
          EXISTING_PRS=$(gh pr list \
            --label tdd-automation \
            --state open \
            --json number,body \
            --jq ".[] | select(.body | contains(\"Closes #$ISSUE_NUMBER\")) | .number")

          if [ -n "$EXISTING_PRS" ]; then
            echo "‚ö†Ô∏è  Found existing open PR(s) for issue #$ISSUE_NUMBER: $EXISTING_PRS"
            echo "   Skipping processing to avoid duplicate PRs"

            # Add a comment to the issue explaining the skip
            gh issue comment "$ISSUE_NUMBER" --body "ü§ñ Duplicate PR Prevention - Skipping processing because an open PR already exists for this issue (#$EXISTING_PRS). The existing PR will be processed to completion. If the PR is stuck or invalid, please close it manually and the queue will retry this spec."

            echo "should_process=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ Issue is open and no duplicate PRs found"
          echo "should_process=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW || github.token }}

      - name: Mark spec as in-progress and trigger Claude Code workflow
        if: steps.check.outputs.should_process == 'true' && steps.validate.outputs.should_process == 'true'
        run: |
          ISSUE_NUMBER="${{ steps.next.outputs.issue_number }}"
          SPEC_ID="${{ steps.next.outputs.spec_id }}"
          TEST_FILE="${{ steps.next.outputs.test_file }}"

          echo "üèÉ Marking issue #$ISSUE_NUMBER as in-progress..."

          # Update labels
          gh issue edit "$ISSUE_NUMBER" --remove-label "tdd-spec:queued"
          gh issue edit "$ISSUE_NUMBER" --add-label "tdd-spec:in-progress"

          # Trigger Claude Code workflow with retry support
          echo "ü§ñ Triggering Claude Code workflow with infrastructure retry support..."
          gh workflow run claude-tdd.yml \
            --field issue_number="$ISSUE_NUMBER" \
            --field retry_attempt=1

          # Add initial comment with workflow instructions
          gh issue comment "$ISSUE_NUMBER" --body "@claude implement this spec using the TDD automation workflow.

          ## ü§ñ AUTOMATION MODE - OPERATE NON-INTERACTIVELY

          You are in **pipeline/automation mode**:
          - ‚úÖ Make autonomous decisions following Omnera architectural patterns
          - ‚úÖ Implement minimal code to pass the test
          - ‚úÖ Use Effect.ts for side effects in Application/Infrastructure layers
          - ‚ùå DO NOT ask clarifying questions - proceed with best judgment
          - ‚ùå DO NOT wait for user approval - implement and commit

          ---

          ## üìã Spec Details

          - **Test File**: \`$TEST_FILE\`
          - **Spec ID**: \`$SPEC_ID\`
          - **Issue**: #$ISSUE_NUMBER

          ## ‚úÖ Success Criteria (Verify Before Finishing)

          **Task is NOT complete until ALL boxes are checked**:
          - [ ] Branch created automatically by Claude Code (pattern: \`claude/issue-$ISSUE_NUMBER-timestamp\`)
          - [ ] \`.fixme()\` removed from test \`$SPEC_ID\` ONLY (not other tests)
          - [ ] Both agents invoked: e2e-test-fixer ‚Üí codebase-refactor-auditor
          - [ ] Code follows layer-based architecture (Domain/Application/Infrastructure/Presentation)
          - [ ] Copyright headers added: \`bun run license\`
          - [ ] Changes committed: \`fix: implement $SPEC_ID\`
          - [ ] Changes pushed to remote branch
          - [ ] **‚ö†Ô∏è CRITICAL (Step 4A): Pull Request created** (verify: \`gh pr list --label tdd-automation\`)
          - [ ] PR has correct format (title, body with \`Closes #$ISSUE_NUMBER\`, label)
          - [ ] **‚ö†Ô∏è CRITICAL (Step 4B): Auto-merge enabled AND verified** (command: \`gh pr view \$PR_NUMBER --json autoMergeRequest\`)
          - [ ] Auto-merge verification shows non-null result with \`mergeMethod: SQUASH\`

          **‚ö†Ô∏è MOST COMMON FAILURES**:
          1. Missing PR creation (issue #1319) ‚Üí spec marked failed after 2 min
          2. Missing auto-merge enablement (PRs #1541, #1546) ‚Üí Pipeline blocked for hours
          3. Auto-merge enabled but not VERIFIED ‚Üí May silently fail

          ---

          ## üîÑ Implementation Workflow (4 Steps - ALL REQUIRED)

          **Note**: Branch is created automatically by Claude Code with pattern \`claude/issue-$ISSUE_NUMBER-{timestamp}\`. No manual branch creation needed.

          ### Step 1: Invoke e2e-test-fixer Agent

          **Use the Task tool** to invoke the **e2e-test-fixer** agent:
          - Agent autonomously locates test \`$SPEC_ID\` in \`$TEST_FILE\`
          - Agent removes \`.fixme()\` from ONE specific test only
          - Agent implements minimal code following architecture:
            - **Domain Layer**: Schemas in \`src/domain/models/\` (Effect Schema)
            - **Application Layer**: Business logic in \`src/application/\` (Effect.ts workflows)
            - **Infrastructure Layer**: External services in \`src/infrastructure/\` (Effect.ts)
            - **Presentation Layer**: UI components in \`src/presentation/components/\` (React)
          - Agent runs specific test: \`bun test:e2e -- $TEST_FILE --grep \"$SPEC_ID\"\`
          - Agent runs regression tests: \`bun test:e2e:regression\`

          **Architecture Notes**:
          - Use Effect.ts (\`Effect.gen\`, \`pipe\`) for side effects in Application/Infrastructure layers
          - Keep Domain layer pure (no side effects)
          - Follow functional programming patterns (immutability, pure functions)

          ### Step 2: Invoke codebase-refactor-auditor Agent (MANDATORY)

          **Use the Task tool** to invoke the **codebase-refactor-auditor** agent:
          - Agent reviews implementation for code quality
          - Agent checks for code duplication
          - Agent ensures architectural compliance
          - Agent refactors and optimizes as needed
          - Agent validates against Omnera best practices

          **IMPORTANT**: This step is MANDATORY even if Step 1 code seems clean.

          ### Step 3: Quality Checks & Commit
          \`\`\`bash
          bun run license           # Add copyright headers (REQUIRED - fails if missing)
          git add -A
          git commit -m \"fix: implement $SPEC_ID\"
          git push -u origin HEAD
          \`\`\`

          ### Step 4A: ‚ö†Ô∏è CREATE PULL REQUEST (MANDATORY - NOT OPTIONAL)

          **THIS IS THE MOST CRITICAL STEP. THE WORKFLOW FAILS WITHOUT IT.**

          \`\`\`bash
          gh pr create \\
            --title \"fix: implement $SPEC_ID\" \\
            --body \"Closes #$ISSUE_NUMBER\" \\
            --label \"tdd-automation\"
          \`\`\`

          **PR Requirements (ALL REQUIRED)**:
          - ‚úÖ Title: Exactly \`fix: implement $SPEC_ID\`
          - ‚úÖ Body: Exactly \`Closes #$ISSUE_NUMBER\` (NO extra text after number - breaks auto-close)
          - ‚úÖ Label: \`tdd-automation\`
          - ‚úÖ Required even if only \`.fixme()\` was removed (no code changes)

          **Failure Example**: Issue #1319 - Claude removed \`.fixme()\`, committed, pushed, but **skipped PR creation** ‚Üí marked as failed ‚Üí required manual intervention

          **Verify PR was created**:
          \`\`\`bash
          gh pr list --label tdd-automation --limit 1 --json number,title | jq '.[0].number'
          \`\`\`

          Save the PR number to a variable for Step 4B:
          \`\`\`bash
          PR_NUMBER=\$(gh pr list --label tdd-automation --limit 1 --json number --jq '.[0].number')
          echo \"Created PR #\$PR_NUMBER\"
          \`\`\`

          ### Step 4B: ‚ö†Ô∏è ENABLE AUTO-MERGE (EQUALLY CRITICAL - DO NOT SKIP)

          **THIS STEP IS REQUIRED IMMEDIATELY AFTER PR CREATION. DO NOT WAIT FOR CI.**

          Without auto-merge, the PR will sit open forever and block the entire pipeline.

          \`\`\`bash
          # Enable auto-merge IMMEDIATELY (don't wait for CI to finish)
          gh pr merge \$PR_NUMBER --auto --squash

          # VERIFY it was enabled (REQUIRED - must show non-null result)
          gh pr view \$PR_NUMBER --json autoMergeRequest --jq '.autoMergeRequest'
          \`\`\`

          **Expected output** (if successful):
          \`\`\`json
          {
            "enabledAt": "2025-11-03T...",
            "enabledBy": {...},
            "mergeMethod": "SQUASH"
          }
          \`\`\`

          **If output is \`null\`**, the command FAILED. You MUST retry:
          \`\`\`bash
          # Retry up to 3 times if needed
          for i in {1..3}; do
            echo \"Attempt \$i: Enabling auto-merge...\"
            if gh pr merge \$PR_NUMBER --auto --squash; then
              sleep 2
              RESULT=\$(gh pr view \$PR_NUMBER --json autoMergeRequest --jq '.autoMergeRequest')
              if [ \"\$RESULT\" != \"null\" ]; then
                echo \"‚úÖ Auto-merge enabled successfully\"
                break
              fi
            fi
            sleep 3
          done
          \`\`\`

          **‚ö†Ô∏è CRITICAL**: Do NOT exit or consider the task complete until auto-merge is verified enabled.

          **Failure Examples**:
          - Issue #1319: PR created, but auto-merge NOT enabled ‚Üí Pipeline blocked
          - PR #1546: All checks passing, mergeable, but stuck open for 2 hours ‚Üí Pipeline blocked
          - PR #1541: Same issue ‚Üí Manual intervention required

          ---

          ## üîÑ CI Monitoring & Failure Handling

          After enabling auto-merge in Step 4B, you MUST monitor CI validation:

          ### Phase 1: Monitor CI Status
          - test.yml CI runs: lint, typecheck, unit tests, E2E regression
          - Check status: \`gh pr checks \$PR_NUMBER\`
          - Auto-merge is already enabled, so PR will merge automatically when CI passes

          ### Phase 2A: If CI Validation PASSES ‚úÖ
          - PR will auto-merge automatically (no action needed)
          - Issue will auto-close via \`Closes #$ISSUE_NUMBER\`
          - Exit successfully

          You can verify the PR merged:
          \`\`\`bash
          gh pr view \$PR_NUMBER --json state --jq '.state'
          # Should show: MERGED
          \`\`\`

          ### Phase 2B: If CI Validation FAILS ‚ùå
          **Retry loop** (max 3 attempts):
          1. Analyze test.yml error logs
          2. Fix code issues
          3. Add retry label: \`gh issue edit $ISSUE_NUMBER --add-label retry:N\` (N=1,2,3)
          4. Commit and push fixes
          5. Wait for next validation
          6. If passes ‚Üí Enable auto-merge (Phase 2A)
          7. If 3rd failure ‚Üí Mark \`tdd-spec:failed\` and exit

          **After 3 failures**:
          \`\`\`bash
          gh issue edit $ISSUE_NUMBER \\
            --remove-label tdd-spec:in-progress \\
            --add-label tdd-spec:failed
          gh issue comment $ISSUE_NUMBER \\
            --body \"‚ùå Failed after 3 attempts. Manual review required.\"
          \`\`\`

          ---

          **Detailed Documentation**: If you need additional context, see \`@docs/development/tdd-automation-pipeline.md\`

          ---
          *ü§ñ Automated via [Queue Processor](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

          echo "‚úÖ Issue updated and @claude mentioned - Claude Code will trigger automatically"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW || github.token }}
