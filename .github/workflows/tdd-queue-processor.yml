name: TDD Queue - Processor

on:
  # Scheduled runs - Every 15 minutes
  schedule:
    - cron: '*/15 * * * *'

  # Manual trigger
  workflow_dispatch:

# Security: Define minimal required permissions
# NOTE: Requires GH_PAT_WORKFLOW secret with 'repo' scope to post @claude mentions
# Comments posted with PAT appear from token owner's account (not github-actions bot)
# This triggers Claude Code workflow via issue_comment event
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

# Prevent concurrent processing (strict serial: one spec at a time)
# IMPORTANT: Shares concurrency group with tdd-daily-refactor.yml
# This ensures queue processor waits when daily refactor is running
concurrency:
  group: tdd-queue
  cancel-in-progress: false

env:
  BUN_VERSION: '1.3.1'

jobs:
  process-queue:
    name: üîÑ Process TDD Queue
    runs-on: ubuntu-latest
    timeout-minutes: 5 # Quick operation: fetch queue, update labels, post @claude comment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git operations

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Configure git with token user
        run: |
          USER_NAME=$(gh api user --jq '.login')
          USER_EMAIL=$(gh api user --jq '.email')
          git config user.name "$USER_NAME"
          git config user.email "$USER_EMAIL"
          echo "‚úÖ Git configured as $USER_NAME <$USER_EMAIL>"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}

      - name: Get next spec from queue
        id: next
        run: |
          echo "üîç Looking for next spec to process..."
          bun run scripts/tdd-automation/queue-manager.ts next
        env:
          GITHUB_OUTPUT: ${{ github.output }}
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW || github.token }}

      - name: Check if spec available
        id: check
        run: |
          if [ "${{ steps.next.outputs.has_next }}" != "true" ]; then
            echo "üì≠ No specs available to process"
            echo "should_process=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found spec to process: ${{ steps.next.outputs.spec_id }}"
            echo "should_process=true" >> $GITHUB_OUTPUT
          fi

      - name: Mark spec as in-progress and trigger Claude Code via @mention
        if: steps.check.outputs.should_process == 'true'
        run: |
          ISSUE_NUMBER="${{ steps.next.outputs.issue_number }}"
          SPEC_ID="${{ steps.next.outputs.spec_id }}"
          TEST_FILE="${{ steps.next.outputs.test_file }}"

          echo "üèÉ Marking issue #$ISSUE_NUMBER as in-progress..."

          # Update labels
          gh issue edit "$ISSUE_NUMBER" --remove-label "tdd-spec:queued"
          gh issue edit "$ISSUE_NUMBER" --add-label "tdd-spec:in-progress"

          # Trigger Claude Code via @claude mention (using user's PAT)
          # This posts a comment from the token owner's account, which triggers the workflow
          echo "ü§ñ Triggering Claude Code via @claude mention..."
          gh issue comment "$ISSUE_NUMBER" --body "@claude implement this spec using the TDD automation workflow.

          ## üìã Spec Details

          - **Test File**: \`$TEST_FILE\`
          - **Spec ID**: \`$SPEC_ID\`
          - **Issue**: #$ISSUE_NUMBER

          ## üîÑ Complete Workflow (Follow ALL Steps)

          ### Step 1: Branch Creation
          \`\`\`bash
          git checkout -b tdd/spec-$SPEC_ID
          # Note: Add suffixes like -clean or -v2 if branch exists
          \`\`\`

          ### Step 2: Run @agent-e2e-test-fixer
          **Agent Responsibilities**:
          - Locate test \`$SPEC_ID\` in \`$TEST_FILE\`
          - Remove \`.fixme()\` from ONE specific test only
          - Run test to see what fails: \`bun test:e2e -- $TEST_FILE\`
          - Implement minimal code following Omnera architecture:
            - Domain schemas in \`src/domain/models/\`
            - Application logic in \`src/application/\`
            - Infrastructure in \`src/infrastructure/\`
            - UI components in \`src/components/\`
          - Use Effect.ts for side effects
          - Follow functional programming patterns
          - Run regression tests: \`bun test:e2e:regression\`

          ### Step 3: Run @agent-codebase-refactor-auditor (MANDATORY)
          **Agent Responsibilities**:
          - Review implementation for code quality
          - Check for code duplication
          - Ensure architectural compliance
          - Refactor and optimize as needed
          - Validate against Omnera best practices

          ### Step 4: Quality & Commit
          \`\`\`bash
          bun run license           # Add copyright headers (REQUIRED)
          git add -A
          git commit -m \"fix: implement $SPEC_ID\"
          git push -u origin HEAD
          \`\`\`

          ### Step 5: ‚ö†Ô∏è CREATE PULL REQUEST (MANDATORY - NOT OPTIONAL)

          **THIS STEP IS REQUIRED. THE WORKFLOW FAILS WITHOUT IT.**

          \`\`\`bash
          gh pr create \\
            --title \"fix: implement $SPEC_ID\" \\
            --body \"Closes #$ISSUE_NUMBER\" \\
            --label \"tdd-automation\"
          \`\`\`

          **Critical Requirements**:
          - ‚úÖ PR body MUST be exactly: \`Closes #$ISSUE_NUMBER\` (no extra text after number)
          - ‚úÖ PR MUST have \`tdd-automation\` label
          - ‚úÖ PR required even if only \`.fixme()\` was removed
          - ‚ùå No PR = Spec marked \`tdd-spec:failed\` after 2 minutes

          **Failure Example**: Issue #1319 removed .fixme, committed, pushed, but didn't create PR ‚Üí marked as failed

          ### Step 6: Verification & Retry

          After PR creation:
          - Workflow automatically verifies PR exists (2 min timeout)
          - test.yml CI runs validation (lint, typecheck, unit tests, E2E regression)
          - If validation fails: Fix code, push again (max 3 retries)
          - If validation passes: PR auto-merges with squash
          - If 3 failures: Issue marked \`tdd-spec:failed\`

          ## ‚úÖ Completion Checklist

          Before finishing, verify ALL of these:
          - [ ] Branch created from main
          - [ ] \`.fixme()\` removed from test $SPEC_ID only
          - [ ] Code implemented following Omnera architecture
          - [ ] Both agents run (e2e-test-fixer + codebase-refactor-auditor)
          - [ ] Copyright headers added (\`bun run license\`)
          - [ ] Changes committed with \`fix: implement $SPEC_ID\`
          - [ ] Changes pushed to remote branch
          - [ ] **Pull Request created** (check: \`gh pr list --label tdd-automation\`)
          - [ ] PR has correct title and body format

          **If any checkbox is unchecked, the task is NOT complete.**

          ---
          *ü§ñ Automated via [Queue Processor](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

          echo "‚úÖ Issue updated and @claude mentioned - Claude Code will trigger automatically"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW || github.token }}
